<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <meta name="theme-color" content="#09090b" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="description"
      content="Verifica os atrasos em tempo real dos comboios da Fertagus."
    />
    <link
      rel="shortcut icon"
      href="./imagens/favicon-96x96.png"
      type="image/x-icon"
    />
    <title>LiveTagus</title>
    <script src="./menu.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>
    <script>
      window.lucide = {
        createIcons: () => {
          const icons = {
            moon: '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>',
            "arrow-right": '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            "sliders-horizontal":
              '<path d="M21 4h-7"/><path d="M10 4H3"/><path d="M21 12h-9"/><path d="M8 12H3"/><path d="M21 20h-5"/><path d="M12 20H3"/><path d="M14 2v4"/><path d="M8 10v4"/><path d="M16 18v4"/>',
            settings:
              '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            "refresh-cw":
              '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            x: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
            "train-track":
              '<path d="M2 17 17 2"/><path d="m2 14 8 8"/><path d="m5 11 8 8"/><path d="m8 8 8 8"/><path d="m11 5 8 8"/><path d="m14 2 8 8"/><path d="M7 22 22 7"/>',
          };

          document.querySelectorAll("[data-lucide]").forEach((element) => {
            const key = element.getAttribute("data-lucide");
            if (!icons[key]) return;

            // Criar um elemento SVG VERDADEIRO (Namespace SVG √© obrigat√≥rio)
            const svg = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "svg",
            );

            // Definir atributos padr√£o do Lucide
            svg.setAttribute("width", "24");
            svg.setAttribute("height", "24");
            svg.setAttribute("viewBox", "0 0 24 24");
            svg.setAttribute("fill", "none");
            svg.setAttribute("stroke", "currentColor");
            svg.setAttribute("stroke-width", "2");
            svg.setAttribute("stroke-linecap", "round");
            svg.setAttribute("stroke-linejoin", "round");

            // Copiar Classes e IDs do elemento original (importante para anima√ß√µes e CSS)
            const currentClasses = element.getAttribute("class") || "";
            svg.setAttribute(
              "class",
              `lucide lucide-${key} ${currentClasses}`.trim(),
            );

            if (element.id) svg.setAttribute("id", element.id);

            // Injetar o path
            svg.innerHTML = icons[key];

            // SUBSTITUIR o elemento original pelo SVG
            element.parentNode.replaceChild(svg, element);
          });
        },
      };
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link href="./style.css" rel="stylesheet" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="h-screen flex flex-col">
    <main role="main" class="h-full flex flex-col w-full">
      <div
        id="maintenance-overlay"
        class="fixed inset-0 z-[100] bg-[#09090b] flex flex-col items-center justify-center p-8 hidden text-center"
      >
        <div class="absolute inset-0 overflow-hidden">
          <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-blue-900/20 rounded-full blur-[100px] pointer-events-none animate-pulse"
          ></div>
        </div>

        <div class="relative z-10 flex flex-col items-center max-w-sm">
          <div
            class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-6 border border-white/10 shadow-xl"
          >
            <i data-lucide="moon" class="w-8 h-8 text-blue-400"></i>
          </div>

          <h1 class="text-2xl font-bold text-white mb-2 tracking-tight">
            Estamos a descansar
          </h1>
          <p class="text-sm text-zinc-400 leading-relaxed mb-6">
            Para reduzir a pegada ecol√≥gica e poupar recursos, a app entra em
            modo de suspens√£o enquanto n√£o h√° comboios. Situa√ß√£o aos fim de
            semanas prevista a resolu√ß√£o em fevereiro.
          </p>

          <div
            class="bg-white/5 rounded-xl p-4 w-full border border-white/5 mb-8"
          >
            <div
              class="flex items-center justify-between mb-2 pb-2 border-b border-white/5"
            >
              <span
                class="text-xs font-bold uppercase text-zinc-500 tracking-wider"
              >
                Diariamente
              </span>
              <span class="text-xs font-mono text-blue-400">02:00 - 05:00</span>
            </div>
            <div class="flex items-center justify-between">
              <span
                class="text-xs font-bold uppercase text-zinc-500 tracking-wider"
              >
                Fim de Semana
              </span>
              <div class="text-right">
                <span class="text-[10px] text-zinc-500 block">
                  S√°bado 02:00 at√©
                </span>
                <span class="text-xs font-mono text-blue-400">
                  Segunda 05:00
                </span>
              </div>
            </div>
          </div>

          <button
            onclick="window.location.reload()"
            class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold uppercase tracking-widest rounded-lg transition-all shadow-lg hover:shadow-blue-500/25 active:scale-95"
          >
            Tentar Novamente
          </button>
          <br />
          <a
            class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold uppercase tracking-widest rounded-lg transition-all shadow-lg hover:shadow-blue-500/25 active:scale-95"
            href="./"
          >
            HomePage
          </a>
        </div>
      </div>

      <div id="pwa-install-prompt" class="install-pwa">
        <p class="text-xs font-medium" style="color: var(--text-primary)">
          Para uma melhor experi√™ncia, instale a Web App.
        </p>
        <button
          onclick="installPWA()"
          class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg w-full"
        >
          Instalar App
        </button>
        <button
          onclick="
            document.getElementById('pwa-install-prompt').style.display = 'none'
          "
          class="text-[10px] text-zinc-500"
        >
          Mais tarde
        </button>
      </div>

      <div
        id="ambient-light"
        class="fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[600px] bg-blue-500/10 rounded-full blur-[120px] pointer-events-none transition-colors duration-1000"
      ></div>

      <div class="relative z-10 w-full max-w-md mx-auto flex flex-col h-full">
        <div class="px-6 pt-8 pb-2 z-20 flex flex-col gap-4">
          <div class="flex justify-between items-end">
            <div class="flex flex-col gap-1 min-w-0 flex-1 mr-2">
              <div
                class="flex items-center gap-2 text-[10px] font-bold tracking-wider uppercase opacity-80"
                style="color: var(--text-secondary)"
              >
                <span>Partida</span>
                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                <span>Destino</span>
              </div>
              <div class="flex items-center gap-2 flex-wrap">
                <h1
                  id="station-display"
                  class="text-2xl font-bold tracking-tight leading-none station-name"
                  style="color: var(--text-primary)"
                >
                  Corroios
                </h1>
                <span class="font-light" style="color: var(--text-secondary)">
                  /
                </span>
                <h2
                  id="dest-display"
                  class="text-xl font-medium tracking-tight leading-none station-name"
                  style="color: var(--accent)"
                >
                  Roma-Areeiro
                </h2>
              </div>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button
                id="config-btn"
                onclick="toggleConfig()"
                aria-label="Configurar rota"
                class="p-3 glass-panel hover:bg-white/10 rounded-xl transition-all text-zinc-400 hover:text-white hidden shadow-sm"
                style="color: var(--text-secondary)"
              >
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
              </button>
              <button
                onclick="openSettings()"
                aria-label="Defini√ß√µes"
                class="p-3 glass-panel hover:bg-white/10 rounded-xl transition-all text-zinc-400 hover:text-white shadow-sm"
                style="color: var(--text-secondary)"
              >
                <i data-lucide="settings" class="w-4 h-4"></i>
              </button>
              <button
                onclick="manualRefresh()"
                id="refresh-btn"
                aria-label="Atualizar"
                class="p-3 glass-panel hover:bg-white/10 rounded-xl transition-all active:scale-90 text-zinc-400 hover:text-white shadow-sm"
                style="color: var(--text-secondary)"
              >
                <i
                  data-lucide="refresh-cw"
                  id="refresh-icon"
                  class="w-4 h-4"
                ></i>
              </button>
            </div>
          </div>

          <div
            id="next-train-header"
            class="hidden opacity-0 transition-opacity duration-500"
          >
            <p
              class="text-xs font-medium flex items-center gap-2 px-3 py-1.5 rounded-full w-fit"
              style="
                color: var(--text-secondary);
                background-color: var(--input-bg);
              "
            >
              <span class="uppercase tracking-widest text-[9px] font-bold">
                Pr√≥ximo
              </span>
              <span
                id="countdown-display"
                class="text-sm font-bold font-mono"
                style="color: var(--accent)"
              >
                -- min -- s
              </span>
            </p>
          </div>

          <div
            id="config-panel"
            class="hidden overflow-hidden transition-all duration-300"
          >
            <div class="p-5 glass-panel rounded-2xl space-y-4 mt-2 shadow-lg">
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1.5">
                  <label
                    for="sel-origin"
                    class="text-[9px] uppercase font-bold tracking-wider"
                    style="color: var(--text-secondary)"
                  >
                    De
                  </label>
                  <select
                    id="sel-origin"
                    aria-label="Esta√ß√£o de Origem"
                    class="select-input w-full"
                  ></select>
                </div>
                <div class="space-y-1.5">
                  <label
                    for="sel-dest"
                    class="text-[9px] uppercase font-bold tracking-wider"
                    style="color: var(--text-secondary)"
                  >
                    Para
                  </label>
                  <select
                    id="sel-dest"
                    aria-label="Esta√ß√£o de Destino"
                    class="select-input w-full"
                  ></select>
                </div>
              </div>
              <div
                class="pt-3 border-t flex justify-between items-center"
                style="border-color: var(--glass-border)"
              >
                <div class="flex flex-col gap-0.5">
                  <div class="flex items-center gap-2">
                    <span
                      id="status-ping"
                      class="relative inline-flex h-1.5 w-1.5 rounded-full bg-blue-500 dot-ping"
                    ></span>
                    <span
                      id="status-text"
                      class="text-[10px] font-bold uppercase tracking-wider"
                      style="color: var(--text-secondary)"
                    >
                      Online
                    </span>
                  </div>
                  <span
                    id="last-updated"
                    class="text-[9px] font-mono pl-3.5"
                    style="color: var(--text-secondary)"
                  >
                    --:--
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div
            id="train-container"
            class="flex-grow overflow-y-auto px-6 pb-32 pt-0 scrollbar-hide mask-gradient"
          >
            <div id="train-list" class="space-y-4 pb-12"></div>
            <div class="next-divider" id="next-divider">
              <div class="next-line"></div>
              <span class="next-text">A Nossa Sugest√£o Para a Viagem</span>
              <div class="next-line"></div>
            </div>
            <div
              id="spotify-card-container"
              class="glass-card rounded-2xl overflow-hidden mb-8 mt-4 hidden animate-fade-in w-full relative group shadow-lg"
            >
              <div class="flex h-36">
                <div
                  class="w-36 h-36 shrink-0 relative bg-zinc-800 border-r border-white/5"
                >
                  <img
                    id="sp-cover"
                    src="./imagens/icon.svg"
                    class="absolute inset-0 w-full h-full object-cover"
                    alt="Capa"
                  />
                </div>

                <div class="flex-1 p-4 flex flex-col justify-between min-w-0">
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <span
                        id="quinzena-badge"
                        class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-zinc-400 tracking-wider uppercase"
                      >
                        Quinzena Atual
                      </span>
                      <i data-lucide="music" class="w-3 h-3 text-zinc-600"></i>
                    </div>

                    <h2
                      id="sp-title"
                      class="text-base font-bold text-zinc-100 leading-tight line-clamp-2 mt-1"
                      style="color: var(--text-primary)"
                    >
                      A carregar...
                    </h2>

                    <p
                      id="sp-artist"
                      class="text-xs text-zinc-400 font-medium truncate mt-1"
                    >
                      Spotify
                    </p>
                  </div>

                  <a
                    id="sp-link"
                    href="#"
                    target="_blank"
                    class="mt-2 flex items-center justify-center gap-2 w-full py-2 bg-[#1DB954] hover:bg-[#1ed760] text-black rounded-lg transition-all active:scale-95"
                  >
                    <svg
                      class="w-4 h-4 fill-black shrink-0"
                      viewBox="0 0 24 24"
                    >
                      <path
                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"
                      />
                    </svg>
                    <span
                      class="text-[10px] font-bold uppercase tracking-widest truncate"
                    >
                      Ouvir no Spotify
                    </span>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <button
            id="load-more-btn"
            onclick="loadMore()"
            class="w-full pb-12 text-xs font-bold uppercase tracking-widest hover:text-zinc-300 transition-colors"
            style="color: var(--text-secondary)"
          >
            Ver Mais Comboios
          </button>
          <div id="global-footer"></div>
        </div>

        <div
          id="train-details-modal"
          class="fixed inset-x-0 bottom-0 h-[85vh] glass-panel rounded-t-[2rem] z-50 transform translate-y-full transition-transform duration-300 flex flex-col shadow-2xl border-t overflow-hidden"
          style="
            border-color: var(--glass-border);
            background-color: var(--modal-bg);
          "
        ></div>

        <div
          id="settings-modal"
          class="fixed inset-0 z-[60] transform translate-x-full transition-transform duration-300 flex flex-col"
          style="background-color: var(--bg-color)"
        >
          <div
            class="p-6 border-b flex justify-between items-center sticky top-0 z-10"
            style="
              border-color: var(--glass-border);
              background-color: var(--modal-bg);
            "
          >
            <h2 class="text-xl font-bold" style="color: var(--text-primary)">
              Defini√ß√µes
            </h2>
            <button
              onclick="closeSettings()"
              aria-label="Fechar Defini√ß√µes"
              class="p-2 bg-white/5 hover:bg-white/10 rounded-full transition-all"
              style="color: var(--text-secondary)"
            >
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="flex-grow overflow-y-auto p-6 space-y-8">
            <div class="settings-section">
              <span class="settings-title">Apar√™ncia</span>
              <div class="glass-card rounded-xl p-1 flex">
                <button
                  onclick="setTheme('dark')"
                  id="btn-theme-dark"
                  class="flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-colors"
                >
                  Escuro
                </button>
                <button
                  onclick="setTheme('light')"
                  id="btn-theme-light"
                  class="flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-colors"
                >
                  Claro
                </button>
                <button
                  onclick="setTheme('system')"
                  id="btn-theme-system"
                  class="flex-1 py-2 text-xs font-bold uppercase rounded-lg transition-colors"
                >
                  Auto
                </button>
              </div>
            </div>

            <div class="settings-section">
              <div class="flex justify-between items-center mb-3">
                <span class="settings-title mb-0">Esta√ß√µes Regulares</span>
                <button
                  id="toggle-regular"
                  onclick="toggleRegularStations()"
                  aria-label="Ativar Esta√ß√µes Regulares"
                  class="toggle-btn bg-zinc-600"
                >
                  <div class="toggle-dot translate-x-0"></div>
                </button>
              </div>

              <div
                id="regular-stations-content"
                class="glass-card rounded-xl p-4 space-y-4 opacity-50 pointer-events-none transition-opacity"
              >
                <div class="flex items-center justify-between">
                  <span
                    class="text-xs font-medium"
                    style="color: var(--text-primary)"
                  >
                    Usar Mesmas Esta√ß√µes (Invertidas)
                  </span>
                  <button
                    id="btn-sync-stations"
                    onclick="toggleSyncStations()"
                    aria-label="Sincronizar Esta√ß√µes"
                    class="toggle-btn bg-zinc-600"
                  >
                    <div class="toggle-dot translate-x-0"></div>
                  </button>
                </div>

                <div
                  class="space-y-3 pt-2 border-t"
                  style="border-color: var(--glass-border)"
                >
                  <p
                    class="text-[10px] uppercase font-bold"
                    style="color: var(--text-secondary)"
                  >
                    Sentido Lisboa (Sul ‚Üí Norte)
                  </p>
                  <div class="grid grid-cols-2 gap-2">
                    <select
                      id="set-lisboa-org"
                      aria-label="Origem Lisboa"
                      class="select-input w-full"
                      onchange="saveRegularStations()"
                    ></select>
                    <select
                      id="set-lisboa-dest"
                      aria-label="Destino Lisboa"
                      class="select-input w-full"
                      onchange="saveRegularStations()"
                    ></select>
                  </div>
                </div>

                <div
                  id="settings-margem-group"
                  class="space-y-3 pt-2 border-t hidden"
                  style="border-color: var(--glass-border)"
                >
                  <p
                    class="text-[10px] uppercase font-bold"
                    style="color: var(--text-secondary)"
                  >
                    Sentido Margem (Norte ‚Üí Sul)
                  </p>
                  <div class="grid grid-cols-2 gap-2">
                    <select
                      id="set-margem-org"
                      aria-label="Origem Margem"
                      class="select-input w-full"
                      onchange="saveRegularStations()"
                    ></select>
                    <select
                      id="set-margem-dest"
                      aria-label="Destino Margem"
                      class="select-input w-full"
                      onchange="saveRegularStations()"
                    ></select>
                  </div>
                </div>
              </div>
            </div>

            <div class="settings-section">
              <div class="flex justify-between items-center mb-3">
                <span class="settings-title mb-0">Hor√°rio Inteligente</span>
                <button
                  id="toggle-smart"
                  onclick="toggleSmartSchedule()"
                  aria-label="Ativar Hor√°rio Inteligente"
                  class="toggle-btn bg-zinc-600"
                >
                  <div class="toggle-dot translate-x-0"></div>
                </button>
              </div>

              <div
                id="smart-schedule-content"
                class="glass-card rounded-xl p-4 space-y-4 opacity-50 pointer-events-none transition-opacity"
              >
                <p class="text-xs text-zinc-400 mb-2">
                  Abre automaticamente o sentido correto dependendo da hora do
                  dia.
                </p>

                <div class="flex items-center justify-between">
                  <span
                    class="text-xs font-medium"
                    style="color: var(--text-primary)"
                  >
                    Manh√£ (05:30 - 13:00)
                  </span>
                  <select
                    id="smart-morning"
                    aria-label="Sentido Manh√£"
                    class="select-input w-32"
                    onchange="saveSmartSchedule()"
                  >
                    <option value="lisboa">Sentido Lisboa</option>
                    <option value="margem">Sentido Margem</option>
                  </select>
                </div>

                <div
                  class="flex items-center justify-between border-t pt-3"
                  style="border-color: var(--glass-border)"
                >
                  <span
                    class="text-xs font-medium"
                    style="color: var(--text-primary)"
                  >
                    Tarde (13:00 - 02:00)
                  </span>
                  <select
                    id="smart-afternoon"
                    aria-label="Sentido Tarde"
                    class="select-input w-32"
                    onchange="saveSmartSchedule()"
                  >
                    <option value="margem">Sentido Margem</option>
                    <option value="lisboa">Sentido Lisboa</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="settings-section">
              <span class="settings-title">Sobre & Legal</span>
              <div class="glass-card rounded-xl p-4 space-y-4">
                <div>
                  <h4
                    class="text-xs font-bold mb-1"
                    style="color: var(--text-primary)"
                  >
                    Funcionamento
                  </h4>
                  <p class="legal-text">
                    Esta aplica√ß√£o cruza dados de hor√°rios est√°ticos com
                    informa√ß√µes em tempo real disponibilizadas publicamente
                    pelas Infraestruturas de Portugal.
                    <br />
                    <br />
                    <strong>Status dos Comboios:</strong>
                    <br />
                    üü¢
                    <span class="text-emerald-500">Verde:</span>
                    Programado/A Horas
                    <br />
                    üü°
                    <span class="text-yellow-500">Amarelo:</span>
                    Atraso detetado
                    <br />
                    üî¥
                    <span class="text-red-500">Vermelho:</span>
                    Suprimido
                  </p>
                </div>
                <div
                  class="border-t pt-3"
                  style="border-color: var(--glass-border)"
                >
                  <h4
                    class="text-xs font-bold mb-1"
                    style="color: var(--text-primary)"
                  >
                    Privacidade & Dados
                  </h4>
                  <p class="legal-text">
                    Esta aplica√ß√£o funciona maioritariamente no seu dispositivo.
                    Todas as prefer√™ncias (esta√ß√µes, temas) s√£o guardadas
                    localmente (LocalStorage) e nunca s√£o enviadas para
                    servidores externos. N√£o existe recolha de dados anal√≠ticos
                    ou pessoais.
                  </p>
                </div>
                <div
                  class="border-t pt-3"
                  style="border-color: var(--glass-border)"
                >
                  <h4
                    class="text-xs font-bold mb-1"
                    style="color: var(--text-primary)"
                  >
                    Isen√ß√£o de Responsabilidade
                  </h4>
                  <p class="legal-text">
                    Esta √© uma aplica√ß√£o n√£o oficial desenvolvida pela
                    comunidade e sem afilia√ß√£o direta √† Fertagus ou √† IP. Os
                    dados s√£o fornecidos "tal como est√£o", podendo existir
                    falhas de servi√ßo alheias √† nossa vontade.
                  </p>
                </div>
                <div class="text-center pt-2">
                  <span
                    class="text-[9px] font-mono"
                    style="color: var(--text-secondary)"
                  >
                    v1.3.1 ‚Ä¢ LiveTagus
                  </span>
                  <br />
                  <span
                    class="text-[9px] font-mono"
                    style="color: var(--text-secondary)"
                  >
                    v2.24.3 ‚Ä¢ API LiveTagus
                  </span>
                </div>
              </div>
            </div>

            <div class="h-10"></div>
          </div>
        </div>

        <div
          id="modal-backdrop"
          onclick="closeDetails()"
          class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"
        ></div>

        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-[60%] z-30">
          <div class="tabs-container">
            <div id="tab-glider" class="glider"></div>
            <button
              onclick="switchTab('lisboa')"
              id="tab-lisboa"
              class="tab-btn active"
            >
              Sentido
              <br />
              Lisboa
            </button>
            <button
              onclick="switchTab('margem')"
              id="tab-margem"
              class="tab-btn"
            >
              Sentido
              <br />
              Margem
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      const PROXY = "https://corsproxy.io/?";
      const API_FERTAGUS_NEW =
        "https://api-transportes.onrender.com/api/fertagus";

      const FERTAGUS_STATIONS = [
        { id: "9468122", key: "setubal", name: "Set√∫bal" },
        { id: "9468098", key: "palmela", name: "Palmela" },
        { id: "9468049", key: "venda_do_alcaide", name: "Venda do Alcaide" },
        { id: "9468007", key: "pinhal_novo", name: "Pinhal Novo" },
        { id: "9417095", key: "penalva", name: "Penalva" },
        { id: "9417236", key: "coina", name: "Coina" },
        { id: "9417186", key: "fogueteiro", name: "Fogueteiro" },
        { id: "9417152", key: "foros_de_amora", name: "Foros de Amora" },
        { id: "9417137", key: "corroios", name: "Corroios" },
        { id: "9417087", key: "pragal", name: "Pragal" },
        { id: "9467033", key: "campolide", name: "Campolide" },
        { id: "9466076", key: "sete_rios", name: "Sete Rios" },
        { id: "9466050", key: "entrecampos", name: "Entrecampos" },
        { id: "9466035", key: "roma_areeiro", name: "Roma-Areeiro" },
      ];

      let DB_LISBOA = null;
      let DB_MARGEM = null;
      let deferredPrompt;

      // --- STATE ---
      let activeTab = "lisboa";
      let isLoading = false;
      let fertagusOrigin = "corroios";
      let fertagusDest = "roma_areeiro";
      let refreshInterval = null;
      let nextTrainInterval = null;
      let isDarkMode = true;
      let currentTheme = "system";
      let currentTrainList = [];
      let displayLimit = 10;
      let nextTrainDate = null;
      let syncStations = true;

      let enableRegularStations = false;
      let enableSmartSchedule = false;

      // --- FUNCTIONS DECLARATIONS ---

      function checkMaintenanceMode() {
        const now = new Date();
        const hour = now.getHours();
        const day = now.getDay();

        let isMaintenance = false;
        if (hour >= 2 && hour < 5) isMaintenance = false;
        if (day === 6 && hour >= 2) isMaintenance = false;
        if (day === 0) isMaintenance = false;
        if (day === 1 && hour < 5) isMaintenance = false;

        if (isMaintenance) {
          document
            .getElementById("maintenance-overlay")
            .classList.remove("block");
          if (window.lucide) lucide.createIcons();
          return true;
        }
        return false;
      }

      window.loadSettings = function () {
        const savedTheme = localStorage.getItem("theme");
        setTheme(savedTheme || "system");

        enableRegularStations =
          localStorage.getItem("enable_regular") === "true";
        enableSmartSchedule = localStorage.getItem("enable_smart") === "true";

        const savedSync = localStorage.getItem("pref_sync_stations");
        syncStations = savedSync === "false" ? false : true;

        updateSettingsToggles();
      };

      window.loadStationPrefs = function (direction) {
        if (!enableRegularStations) return;
        const savedOrg = localStorage.getItem(`pref_${direction}_org`);
        const savedDest = localStorage.getItem(`pref_${direction}_dest`);

        if (savedOrg && FERTAGUS_STATIONS.find((s) => s.key === savedOrg))
          fertagusOrigin = savedOrg;
        if (savedDest && FERTAGUS_STATIONS.find((s) => s.key === savedDest))
          fertagusDest = savedDest;
      };

      window.saveStationPrefs = function () {
        if (!enableRegularStations) return;
        localStorage.setItem(`pref_${activeTab}_org`, fertagusOrigin);
        localStorage.setItem(`pref_${activeTab}_dest`, fertagusDest);

        if (syncStations) {
          const otherTab = activeTab === "lisboa" ? "margem" : "lisboa";
          localStorage.setItem(`pref_${otherTab}_org`, fertagusDest);
          localStorage.setItem(`pref_${otherTab}_dest`, fertagusOrigin);
        }
      };

      window.populateSettingsUI = function () {
        const optsLisboa = FERTAGUS_STATIONS.map(
          (s) => `<option value="${s.key}">${s.name}</option>`,
        ).join("");

        [
          "set-lisboa-org",
          "set-lisboa-dest",
          "set-margem-org",
          "set-margem-dest",
        ].forEach((id) => {
          document.getElementById(id).innerHTML = optsLisboa;
        });

        document.getElementById("set-lisboa-org").value =
          localStorage.getItem("pref_lisboa_org") || "setubal";
        document.getElementById("set-lisboa-dest").value =
          localStorage.getItem("pref_lisboa_dest") || "roma_areeiro";
        document.getElementById("set-margem-org").value =
          localStorage.getItem("pref_margem_org") || "roma_areeiro";
        document.getElementById("set-margem-dest").value =
          localStorage.getItem("pref_margem_dest") || "setubal";

        document.getElementById("smart-morning").value =
          localStorage.getItem("pref_morning") || "lisboa";
        document.getElementById("smart-afternoon").value =
          localStorage.getItem("pref_afternoon") || "margem";

        updateSyncUI();
      };

      window.openSettings = function () {
        populateSettingsUI();
        updateSettingsToggles();
        document
          .getElementById("settings-modal")
          .classList.remove("translate-x-full");
      };

      window.closeSettings = function () {
        document
          .getElementById("settings-modal")
          .classList.add("translate-x-full");
        loadStationPrefs(activeTab);
        populateOriginSelect();
        updateDestinationOptions();
        updateStationLabels();
        loadData();
      };

      window.setTheme = function (mode) {
        currentTheme = mode;
        localStorage.setItem("theme", mode);
        applyTheme();
      };

      window.applyTheme = function () {
        let effectiveDark = false;
        if (currentTheme === "system") {
          effectiveDark = window.matchMedia(
            "(prefers-color-scheme: dark)",
          ).matches;
        } else {
          effectiveDark = currentTheme === "dark";
        }

        isDarkMode = effectiveDark;
        document.documentElement.setAttribute(
          "data-theme",
          isDarkMode ? "dark" : "light",
        );

        const btnDark = document.getElementById("btn-theme-dark");
        const btnLight = document.getElementById("btn-theme-light");
        const btnSystem = document.getElementById("btn-theme-system");

        const activeStyle = "background-color: var(--accent); color: white;";
        const inactiveStyle =
          "background-color: var(--input-bg); color: var(--text-secondary);";

        if (btnDark && btnLight && btnSystem) {
          btnDark.style = currentTheme === "dark" ? activeStyle : inactiveStyle;
          btnLight.style =
            currentTheme === "light" ? activeStyle : inactiveStyle;
          btnSystem.style =
            currentTheme === "system" ? activeStyle : inactiveStyle;
        }
      };

      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          if (currentTheme === "system") applyTheme();
        });

      window.toggleRegularStations = function () {
        enableRegularStations = !enableRegularStations;
        localStorage.setItem("enable_regular", enableRegularStations);
        updateSettingsToggles();
      };

      window.toggleSmartSchedule = function () {
        enableSmartSchedule = !enableSmartSchedule;
        localStorage.setItem("enable_smart", enableSmartSchedule);
        updateSettingsToggles();
      };

      window.toggleSyncStations = function () {
        syncStations = !syncStations;
        localStorage.setItem("pref_sync_stations", syncStations);
        updateSyncUI();
      };

      window.updateSettingsToggles = function () {
        updateToggleVisual(
          "toggle-regular",
          "regular-stations-content",
          enableRegularStations,
        );
        updateToggleVisual(
          "toggle-smart",
          "smart-schedule-content",
          enableSmartSchedule,
        );
      };

      function updateToggleVisual(btnId, contentId, isEnabled) {
        const btn = document.getElementById(btnId);
        const dot = btn.querySelector(".toggle-dot");
        const content = document.getElementById(contentId);

        if (isEnabled) {
          btn.classList.remove("bg-zinc-600");
          btn.classList.add("bg-blue-600");
          dot.classList.remove("translate-x-0");
          dot.classList.add("translate-x-5");
          content.classList.remove("opacity-50", "pointer-events-none");
        } else {
          btn.classList.add("bg-zinc-600");
          btn.classList.remove("bg-blue-600");
          dot.classList.add("translate-x-0");
          dot.classList.remove("translate-x-5");
          content.classList.add("opacity-50", "pointer-events-none");
        }
      }

      window.updateSyncUI = function () {
        const btn = document.getElementById("btn-sync-stations");
        const dot = btn.querySelector("div");
        const margemGroup = document.getElementById("settings-margem-group");

        if (syncStations) {
          btn.classList.add("bg-blue-600");
          btn.classList.remove("bg-zinc-600");
          dot.classList.add("translate-x-5");
          dot.classList.remove("translate-x-0");
          margemGroup.classList.add("hidden");
        } else {
          btn.classList.add("bg-zinc-600");
          btn.classList.remove("bg-blue-600");
          dot.classList.add("translate-x-0");
          dot.classList.remove("translate-x-5");
          margemGroup.classList.remove("hidden");
        }
      };

      window.saveRegularStations = function () {
        const lOrg = document.getElementById("set-lisboa-org").value;
        const lDest = document.getElementById("set-lisboa-dest").value;
        const mOrg = document.getElementById("set-margem-org").value;
        const mDest = document.getElementById("set-margem-dest").value;

        // Remove validation here, let user choose freely

        localStorage.setItem("pref_lisboa_org", lOrg);
        localStorage.setItem("pref_lisboa_dest", lDest);

        if (syncStations) {
          localStorage.setItem("pref_margem_org", lDest);
          localStorage.setItem("pref_margem_dest", lOrg);
        } else {
          localStorage.setItem("pref_margem_org", mOrg);
          localStorage.setItem("pref_margem_dest", mDest);
        }
      };

      window.saveSmartSchedule = function () {
        const morn = document.getElementById("smart-morning").value;
        const aft = document.getElementById("smart-afternoon").value;
        localStorage.setItem("pref_morning", morn);
        localStorage.setItem("pref_afternoon", aft);
      };

      window.setupPWA = function () {
        // Remove start_url property from manifest as requested
        const iconUrl = new URL("./imagens/icon.svg", window.location.href)
          .href;
        const link = document.createElement("link");
        link.rel = "manifest";
        // Removed start_url to fix console error
        link.href = URL.createObjectURL(
          new Blob(
            [
              JSON.stringify({
                name: "LiveTagus",
                short_name: "LiveTagus",
                display: "standalone",
                background_color: "#09090b",
                theme_color: "#09090b",
                orientation: "portrait",
                icons: [
                  {
                    src: iconUrl,
                    sizes: "512x512",
                    type: "image/svg+xml",
                  },
                ],
              }),
            ],
            { type: "application/json" },
          ),
        );
        document.head.appendChild(link);

        // Install Prompt Logic
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          // Check if already running standalone
          if (!window.matchMedia("(display-mode: standalone)").matches) {
            document.getElementById("pwa-install-prompt").style.display =
              "flex";
          }
        });
      };

      window.installPWA = async function () {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          deferredPrompt = null;
          document.getElementById("pwa-install-prompt").style.display = "none";
        }
      };

      window.populateSelects = function () {
        const orgSel = document.getElementById("sel-origin");
        const dstSel = document.getElementById("sel-dest");
        const opts = FERTAGUS_STATIONS.map(
          (s) => `<option value="${s.key}">${s.name}</option>`,
        ).join("");
        orgSel.innerHTML = opts;
        dstSel.innerHTML = opts;
      };

      window.toggleConfig = function () {
        const p = document.getElementById("config-panel");
        p.classList.toggle("hidden");
      };

      window.updateStations = function () {
        updateStationLabels();
        loadData();
      };

      window.updateStationLabels = function () {
        const org = FERTAGUS_STATIONS.find((s) => s.key === fertagusOrigin);
        const dst = FERTAGUS_STATIONS.find((s) => s.key === fertagusDest);
        if (org)
          document.getElementById("station-display").innerText = org.name;
        if (dst) document.getElementById("dest-display").innerText = dst.name;
      };

      window.populateOriginSelect = function () {
        const orgSel = document.getElementById("sel-origin");
        orgSel.innerHTML = "";
        let options = [];
        if (activeTab === "lisboa") {
          options = FERTAGUS_STATIONS.slice(0, FERTAGUS_STATIONS.length - 1);
        } else {
          options = FERTAGUS_STATIONS.slice(1).reverse();
        }
        options.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.key;
          opt.text = s.name;
          orgSel.appendChild(opt);
        });
        if (options.find((o) => o.key === fertagusOrigin)) {
          orgSel.value = fertagusOrigin;
        } else {
          if (activeTab === "lisboa") orgSel.value = "setubal";
          else orgSel.value = "roma_areeiro";
          fertagusOrigin = orgSel.value;
        }
      };

      window.updateDestinationOptions = function () {
        const destSel = document.getElementById("sel-dest");
        destSel.innerHTML = "";
        const orgIdx = FERTAGUS_STATIONS.findIndex(
          (s) => s.key === fertagusOrigin,
        );
        let validDestinations = [];
        if (activeTab === "lisboa") {
          validDestinations = FERTAGUS_STATIONS.slice(orgIdx + 1);
        } else {
          validDestinations = FERTAGUS_STATIONS.slice(0, orgIdx).reverse();
        }
        validDestinations.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.key;
          opt.text = s.name;
          destSel.appendChild(opt);
        });

        // Auto select first valid if current is invalid
        if (validDestinations.find((o) => o.key === fertagusDest)) {
          destSel.value = fertagusDest;
        } else {
          if (validDestinations.length > 0) {
            destSel.value = validDestinations[0].key;
            fertagusDest = destSel.value;
          }
        }
      };

      window.validateRoute = function () {
        // Validation removed as requested, using default updateDestinationOptions logic
      };

      window.parseTimeStr = function (str) {
        if (!str) return null;
        const [h, m] = str.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        if (d < new Date(Date.now() - 4 * 3600000)) d.setDate(d.getDate() + 1);
        return d;
      };

      window.addMinutes = function (str, min) {
        const d = parseTimeStr(str);
        if (!d) return "--:--";
        d.setMinutes(d.getMinutes() + min);
        return d.toLocaleTimeString("pt-PT", {
          hour: "2-digit",
          minute: "2-digit",
        });
      };

      window.updateNextCountdown = function () {
        if (!nextTrainDate) {
          document
            .getElementById("next-train-header")
            .classList.add("opacity-0", "hidden");
          return;
        }
        const now = new Date();
        let diff = Math.floor((nextTrainDate - now) / 1000);
        if (diff < 0) diff = 0;
        const min = Math.floor(diff / 60);
        const sec = Math.floor((diff % 60) / 10) * 10;
        document.getElementById("countdown-display").innerText =
          `${min} min ${sec.toString().padStart(2, "0")} s`;
        const header = document.getElementById("next-train-header");
        header.classList.remove("hidden");
        requestAnimationFrame(() => header.classList.remove("opacity-0"));
      };

      async function fetchFertagusNewAPI() {
        const currentDB = activeTab === "lisboa" ? DB_LISBOA : DB_MARGEM;
        if (!currentDB) return [];
        try {
          const res = await fetch(API_FERTAGUS_NEW);
          if (!res.ok) throw new Error("API Middleware Error");
          const data = await res.json();
          const futureTrains = data.futureTrains || {};
          const apiTrains = Object.values(data).filter(
            (v) => v && v["id-comboio"],
          );
          const orgInfo = FERTAGUS_STATIONS.find(
            (s) => s.key === fertagusOrigin,
          );
          const dstInfo = FERTAGUS_STATIONS.find((s) => s.key === fertagusDest);
          const now = new Date();
          const allDbTrips = currentDB.trips.filter((trip) => {
            if (!trip[fertagusOrigin] || !trip[fertagusDest]) return false;
            return (
              parseTimeStr(trip[fertagusOrigin]) <
              parseTimeStr(trip[fertagusDest])
            );
          });

          const processed = allDbTrips
            .map((dbTrain) => {
              const scheduledTimeStr = dbTrain[fertagusOrigin];
              const scheduledDate = parseTimeStr(scheduledTimeStr);
              const scheduledDestStr = dbTrain[fertagusDest];
              const apiTrain = apiTrains.find(
                (t) => t["id-comboio"] == dbTrain.id,
              );
              let originNode = null;
              let destNode = null;
              if (apiTrain) {
                originNode = apiTrain.NodesPassagemComboio.find(
                  (n) => n.EstacaoID == orgInfo.id,
                );
                destNode = apiTrain.NodesPassagemComboio.find(
                  (n) =>
                    n.NomeEstacao.toUpperCase() === dstInfo.name.toUpperCase(),
                );
              }
              let mainTime = scheduledTimeStr;
              let secondaryTime = null;
              let status = "Programado";
              let dotStatus = "gray";
              let pulse = false;
              let context = null;
              let isLive = false;
              let isSuppressed = false;
              let hasPassedOrigin = false;
              let originLabel = "FERTAGUS";
              if (dbTrain.setubal) originLabel = "SET√öBAL";
              else if (dbTrain.coina) originLabel = "COINA";
              let arrTime = scheduledDestStr;

              if (apiTrain && originNode) {
                isLive = apiTrain.Live;
                isSuppressed = apiTrain.SituacaoComboio === "SUPRIMIDO";
                hasPassedOrigin = originNode.ComboioPassou;
                if (destNode && destNode.HoraPrevista) {
                  arrTime = destNode.HoraPrevista.substring(0, 5);
                }
                if (isSuppressed) {
                  status = "SUPRIMIDO";
                  dotStatus = "red";
                  pulse = true;
                } else if (apiTrain) {
                  const progStr = originNode.HoraProgramada;
                  const prevStr = originNode.HoraPrevista;
                  const obsStr = originNode.Observacoes;
                  let diffMin = 0;
                  let explicitDelayFound = false;
                  if (
                    apiTrain.SituacaoComboio &&
                    /atraso/i.test(apiTrain.SituacaoComboio)
                  ) {
                    const match = apiTrain.SituacaoComboio.match(/(\d+)/);
                    if (match) {
                      diffMin = parseInt(match[1]);
                      explicitDelayFound = true;
                    }
                  }
                  const obsMatch = obsStr
                    ? obsStr.match(/Hora Prevista:(\d{2}:\d{2})/)
                    : null;
                  if (obsMatch) {
                    mainTime = obsMatch[1];
                    if (!explicitDelayFound) {
                      const dProg = parseTimeStr(progStr);
                      const dObs = parseTimeStr(mainTime);
                      diffMin = Math.round((dObs - dProg) / 60000);
                    }
                  } else if (explicitDelayFound) {
                    mainTime = addMinutes(progStr, diffMin);
                  } else if (prevStr && prevStr !== progStr) {
                    mainTime = prevStr.substring(0, 5);
                    const dProg = parseTimeStr(progStr);
                    const dPrev = parseTimeStr(mainTime);
                    diffMin = Math.round((dPrev - dProg) / 60000);
                  } else {
                    mainTime = progStr.substring(0, 5);
                  }
                  if (diffMin > 0) {
                    status = `Atraso ${diffMin} min`;
                    dotStatus = "yellow";
                    pulse = true;
                    secondaryTime = progStr.substring(0, 5);
                    isLive = true;
                  } else {
                    if (isLive || explicitDelayFound || obsMatch) {
                      status = "A Horas";
                      dotStatus = "green";
                      pulse = true;
                      isLive = true;
                    } else {
                      status = "Programado";
                      dotStatus = "green";
                      pulse = true;
                    }
                  }
                  const currentIdx = apiTrain.NodesPassagemComboio.findIndex(
                    (n) => !n.ComboioPassou,
                  );
                  if (currentIdx >= 0) {
                    const currNode = apiTrain.NodesPassagemComboio[currentIdx];
                    const currName = currNode.NomeEstacao;
                    if (hasPassedOrigin && !isSuppressed)
                      status = `Em ${currName}`;
                    const prevNode =
                      currentIdx > 0
                        ? apiTrain.NodesPassagemComboio[currentIdx - 1]
                        : null;
                    const nextNode = apiTrain.NodesPassagemComboio[
                      currentIdx + 1
                    ]
                      ? apiTrain.NodesPassagemComboio[currentIdx + 1]
                      : null;
                    context = {
                      prev: prevNode
                        ? {
                            name: prevNode.NomeEstacao,
                            time: prevNode.HoraReal
                              ? prevNode.HoraReal.substring(0, 5)
                              : "--:--",
                          }
                        : null,
                      curr: {
                        name: currName,
                        time: currNode.HoraPrevista
                          ? currNode.HoraPrevista.substring(0, 5)
                          : currNode.HoraProgramada.substring(0, 5),
                      },
                      next: nextNode
                        ? {
                            name: nextNode.NomeEstacao,
                            time: nextNode.HoraPrevista
                              ? nextNode.HoraPrevista.substring(0, 5)
                              : nextNode.HoraProgramada.substring(0, 5),
                          }
                        : null,
                    };
                  }
                }
              } else {
                const fStatus = futureTrains[dbTrain.id];
                if (fStatus) {
                  if (fStatus.toUpperCase().includes("SUPRIMIDO")) {
                    status = "SUPRIMIDO";
                    dotStatus = "red";
                    pulse = true;
                    isSuppressed = true;
                  } else if (/atraso/i.test(fStatus)) {
                    const match = fStatus.match(/(\d+)/);
                    if (match) {
                      const delay = parseInt(match[1]);
                      status = `Atraso ${delay} min`;
                      dotStatus = "yellow";
                      pulse = true;
                      mainTime = addMinutes(scheduledTimeStr, delay);
                      secondaryTime = scheduledTimeStr;
                      isLive = true;
                    }
                  } else if (
                    /programado/i.test(fStatus) ||
                    /hora/i.test(fStatus)
                  ) {
                    status = "Programado";
                    dotStatus = "green";
                    pulse = true;
                  }
                }
              }
              if (isSuppressed && scheduledDate < now) return null;
              if (isLive) {
                if (destNode && destNode.ComboioPassou) return null;
              } else {
                if (scheduledDate < now) return null;
              }
              const effectiveDate = parseTimeStr(mainTime);
              return {
                id: dbTrain.id,
                num: dbTrain.id,
                op: originLabel,
                time: mainTime,
                secTime: secondaryTime,
                dest: dstInfo.name,
                status: status,
                arr: arrTime,
                dotStatus: dotStatus,
                pulse: pulse,
                isLive: isLive,
                isSuppressed: isSuppressed,
                carriages: dbTrain.carruagens,
                occupancy: dbTrain.ocupacao,
                context: context,
                isPassed: hasPassedOrigin,
                isEffectiveFuture: !hasPassedOrigin && !isSuppressed,
                rawTime: scheduledDate,
                effectiveDate: effectiveDate,
                fullSchedule: apiTrain ? apiTrain.NodesPassagemComboio : null,
              };
            })
            .filter((t) => t !== null)
            .sort((a, b) => a.effectiveDate - b.effectiveDate);
          return processed;
        } catch (e) {
          console.error("Erro Fertagus API:", e);
          return [];
        }
      }

      async function getTrains() {
        const apiData = await fetchFertagusNewAPI();
        return apiData;
      }

      function openDetails(trainId) {
        const t = currentTrainList.find((train) => train.id == trainId);
        if (!t) return;
        let occColorClass = "text-emerald-500";
        let barColorClass = "bg-emerald-500";
        if (t.occupancy > 85) {
          occColorClass = "text-red-500";
          barColorClass = "bg-red-500";
        } else if (t.occupancy > 50) {
          occColorClass = "text-yellow-500";
          barColorClass = "bg-yellow-500";
        } else {
          occColorClass = "text-emerald-500";
          barColorClass = "bg-emerald-500";
        }
        let carsHtml = "";
        const count = t.carriages || 4;
        const filledCount = t.occupancy
          ? Math.round((t.occupancy / 100) * count)
          : count;
        if (t.occupancy !== null && t.occupancy !== undefined) {
          for (let c = 0; c < count; c++) {
            const isFilled = c < filledCount;
            const color = isFilled ? barColorClass : "bg-zinc-700/50";
            carsHtml += `<div class="h-2 flex-1 rounded-sm ${color} transition-all"></div>`;
          }
        } else {
          for (let c = 0; c < count; c++) {
            carsHtml += `<div class="h-2 flex-1 rounded-sm bg-zinc-700/50 border border-zinc-600/30"></div>`;
          }
        }
        let timelineHtml = "";
        if (t.fullSchedule) {
          t.fullSchedule.forEach((node, i) => {
            const isPassed = node.ComboioPassou;
            const isNext =
              !isPassed && (i === 0 || t.fullSchedule[i - 1].ComboioPassou);
            const dotColor = isPassed
              ? "bg-zinc-700 border-zinc-700"
              : isNext
                ? "bg-blue-500 border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.4)]"
                : "bg-zinc-800 border-zinc-600";
            const textColor = isPassed
              ? "text-zinc-600"
              : isNext
                ? "text-[var(--text-primary)] font-bold"
                : "text-[var(--text-secondary)]";
            const timeColor = isPassed
              ? "text-zinc-700"
              : isNext
                ? "text-blue-400 font-bold"
                : "text-zinc-500";
            const scheduledTime = node.HoraProgramada.substring(0, 5);
            const predictedTime = node.HoraPrevista
              ? node.HoraPrevista.substring(0, 5)
              : scheduledTime;
            let timeDisplay = scheduledTime;
            let subTime = "";
            if (predictedTime !== scheduledTime && !t.isSuppressed) {
              timeDisplay = predictedTime;
              subTime = scheduledTime;
            }
            timelineHtml += `
                    <div class="relative z-10 flex items-center mb-8 last:mb-0 group">
                        <div class="w-14 text-right mr-6 flex-shrink-0 flex flex-col items-end">
                            <span class="font-mono text-sm ${timeColor} leading-none">${timeDisplay}</span>
                            ${subTime ? `<span class="text-[9px] text-zinc-700 line-through decoration-zinc-700/50 mt-0.5">${subTime}</span>` : ""}
                        </div>
                        <div class="w-3 h-3 rounded-full border-2 ${dotColor} flex-shrink-0 transition-all group-hover:scale-110 z-20 relative"></div>
                        <div class="ml-6 flex-1">
                            <h4 class="text-sm ${textColor}">${node.NomeEstacao}</h4>
                            ${isPassed ? "" : isNext ? '<span class="text-[9px] text-blue-500 uppercase tracking-wider font-bold animate-pulse block mt-0.5">Pr√≥xima</span>' : ""}
                        </div>
                    </div>`;
          });
        } else {
          const currentDB = activeTab === "lisboa" ? DB_LISBOA : DB_MARGEM;
          const dbTrain = currentDB.trips.find((trip) => trip.id == t.id);
          if (dbTrain) {
            const stations = FERTAGUS_STATIONS.filter((st) => dbTrain[st.key]);
            let stationsToRender = stations;
            if (activeTab === "margem") {
              stationsToRender = [...stations].reverse();
            }
            stationsToRender.forEach((st) => {
              const time = dbTrain[st.key];
              if (time) {
                timelineHtml += `
                            <div class="relative z-10 flex items-center mb-8 last:mb-0">
                                <div class="w-14 text-right mr-6 flex-shrink-0">
                                    <span class="font-mono text-sm text-zinc-500 leading-none">${time}</span>
                                </div>
                                <div class="w-3 h-3 rounded-full border-2 bg-zinc-800 border-zinc-600 flex-shrink-0 z-20 relative"></div>
                                <div class="ml-6 flex-1">
                                    <h4 class="text-sm text-zinc-400">${st.name}</h4>
                                </div>
                            </div>`;
              }
            });
          }
        }
        const fullContent = `
                <div class="flex flex-col h-full bg-[var(--modal-bg)]">
                    <div class="relative z-20 backdrop-blur-md border-b border-white/5 pt-6 pb-6 px-6 shadow-xl" style="background-color: var(--glass-bg)">
                        <button onclick="closeDetails()" class="absolute top-5 right-5 p-2 bg-white/5 hover:bg-white/10 rounded-full text-zinc-400 hover:text-white transition-all">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                        <div class="flex flex-col gap-6">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">Fertagus</span>
                                    <span class="font-mono text-xs text-zinc-600">#${t.num}</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <h2 class="text-2xl font-bold tracking-tight leading-none" style="color: var(--text-primary)">${t.dest}</h2>
                                    <div class="text-right">
                                        <span class="text-3xl font-mono font-bold tracking-tighter leading-none" style="color: var(--text-primary)">${t.time}</span>
                                        ${t.secTime ? `<span class="block text-xs text-zinc-600 line-through text-right mt-0.5 font-mono">${t.secTime}</span>` : ""}
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mt-3">
                                    <span class="text-xs text-zinc-500">De <span class="font-medium" style="color: var(--text-secondary)">${t.op === "FERTAGUS" ? (activeTab === "lisboa" ? "Set√∫bal/Coina" : "Roma-Areeiro") : t.op}</span></span>
                                    <div class="flex items-center gap-2 px-2 py-1 rounded-full bg-white/5 border border-white/5">
                                        <div class="w-1.5 h-1.5 rounded-full ${t.dotStatus === "green" ? "bg-emerald-500" : t.dotStatus === "yellow" ? "bg-yellow-500" : "bg-red-500"} animate-pulse"></div>
                                        <span class="text-[10px] font-bold uppercase text-zinc-300 leading-none">${t.status}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="rounded-xl p-3 border border-white/5 flex flex-col justify-between min-h-[70px]" style="background-color: var(--card-bg)">
                                    <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Carruagens</span>
                                    <div class="flex items-end gap-1 mt-1">
                                        <span class="text-2xl font-mono font-bold leading-none" style="color: var(--text-primary)">${t.carriages}</span>
                                        <span class="text-[10px] text-zinc-500 mb-0.5">unid.</span>
                                    </div>
                                </div>
                                <div class="rounded-xl p-3 border border-white/5 flex flex-col justify-between min-h-[70px]" style="background-color: var(--card-bg)">
                                    <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Ocupa√ß√£o</span>
                                    <div class="flex items-end gap-1 mt-1">
                                        ${
                                          t.occupancy !== null
                                            ? `<span class="text-2xl font-mono font-bold ${occColorClass} leading-none">${t.occupancy}%</span>`
                                            : `<span class="text-sm text-zinc-600 italic">--</span>`
                                        }
                                    </div>
                                </div>
                            </div>
                            ${
                              t.occupancy !== null
                                ? `
                            <div class="flex gap-1.5 w-full mt-1">
                                ${carsHtml}
                            </div>`
                                : ""
                            }
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto px-6 py-8 relative" style="background-color: var(--modal-bg)">
                        <div class="absolute left-[85px] top-0 bottom-0 w-[1px] bg-zinc-800"></div>
                        ${timelineHtml}
                        <div class="h-12"></div> </div>
                </div>
            `;
        const modal = document.getElementById("train-details-modal");
        modal.innerHTML = fullContent;
        const backdrop = document.getElementById("modal-backdrop");
        modal.classList.remove("translate-y-full");
        backdrop.classList.remove("hidden");
        setTimeout(() => backdrop.classList.remove("opacity-0"), 10);
        if (window.lucide) lucide.createIcons();
      }

      function closeDetails() {
        const modal = document.getElementById("train-details-modal");
        const backdrop = document.getElementById("modal-backdrop");
        modal.classList.add("translate-y-full");
        backdrop.classList.add("opacity-0");
        setTimeout(() => backdrop.classList.add("hidden"), 300);
      }

      window.renderList = function (list) {
        const container = document.getElementById("train-list");
        const loadMoreBtn = document.getElementById("load-more-btn");
        currentTrainList = list;

        // Clean container for full re-render
        container.innerHTML = "";

        if (!list || !list.length) {
          container.innerHTML = `<div class="h-60 flex flex-col items-center justify-center text-zinc-500 gap-3"><i data-lucide="train-track" class="w-10 h-10 opacity-20"></i><p class="text-xs tracking-wider uppercase font-medium">Sem comboios pr√≥ximos</p></div>`;
          if (window.lucide) lucide.createIcons();
          loadMoreBtn.classList.add("hidden");
          nextTrainDate = null;
          updateNextCountdown();
          return;
        }

        // Pagination
        const visibleList = list.slice(0, displayLimit);
        if (list.length > displayLimit) loadMoreBtn.classList.remove("hidden");
        else loadMoreBtn.classList.add("hidden");

        const colorText = "text-blue-400";

        // Identify Next Train
        let nextTrainIndex = list.findIndex(
          (t) => t.isEffectiveFuture && !t.isSuppressed,
        );
        if (nextTrainIndex === -1 && list.some((t) => !t.isSuppressed))
          nextTrainIndex = list.length - 1;
        if (nextTrainIndex === -1) nextTrainIndex = 0;

        nextTrainDate = list[nextTrainIndex]?.effectiveDate;
        updateNextCountdown();

        const dividerHTML = `
                <div class="next-divider" id="next-divider">
                    <div class="next-line"></div>
                    <span class="next-text">Pr√≥ximo Comboio</span>
                    <div class="next-line"></div>
                </div>
                <p class="warning-text">Aten√ß√£o: Os hor√°rios e estado de circula√ß√£o podem sofrer altera√ß√µes sem aviso pr√©vio. Esteja na esta√ß√£o √† hora programada.</p>
            `;

        // Loop and render ALL visible items (past and future)
        visibleList.forEach((t, i) => {
          const cardId = `train-${t.id}`;
          const isNext = i === nextTrainIndex;
          const isPassed = i < nextTrainIndex;

          // If this is the next train, inject separator BEFORE it
          if (isNext) {
            container.insertAdjacentHTML("beforeend", dividerHTML);
          }

          let dotClass = "bg-zinc-600";
          let glowColor = "rgba(59, 130, 246, 0.5)";
          if (t.dotStatus === "green") {
            dotClass = "bg-emerald-500";
            glowColor = "rgba(16, 185, 129, 0.5)";
          } else if (t.dotStatus === "yellow") {
            dotClass = "bg-amber-500";
            glowColor = "rgba(245, 158, 11, 0.5)";
          } else if (t.dotStatus === "red") {
            dotClass = "bg-red-500";
            glowColor = "rgba(239, 68, 68, 0.5)";
          }

          dotClass += ` shadow-[0_0_8px_${glowColor}]`;

          let pulseStyle = "";
          if (t.dotStatus !== "gray") {
            dotClass += " dot-ping";
            pulseStyle = `style="--dot-color-glow: ${glowColor}"`;
          }

          const opacityClass = isPassed
            ? "opacity-60 grayscale-[0.5]"
            : "opacity-100";
          const timeClass = t.isSuppressed
            ? "line-through text-zinc-500 opacity-70"
            : "";
          const arrClass = t.isSuppressed ? "opacity-0" : "";
          const statusTextClass = t.isSuppressed
            ? "text-red-400 font-bold"
            : t.status.includes("Atraso")
              ? "text-yellow-400"
              : "text-zinc-400";

          let carsHtml = "";
          if (t.carriages) {
            const occ = t.occupancy !== null ? t.occupancy : 0;
            let fillColor = "bg-emerald-500";
            if (occ === 0) fillColor = "bg-blue-500";
            else if (occ > 85) fillColor = "bg-red-500";
            else if (occ > 50) fillColor = "bg-yellow-500";
            else fillColor = "bg-emerald-500";

            const wrapperWidth = t.carriages === 8 ? "w-full" : "w-1/2";
            const filledCount = t.occupancy
              ? Math.round((t.occupancy / 100) * t.carriages)
              : t.carriages;

            let blocks = "";
            for (let c = 0; c < t.carriages; c++) {
              const colorClass = c < filledCount ? fillColor : "bg-zinc-700";
              blocks += `<div class="carriage-block flex-1 ${colorClass} opacity-90"></div>`;
            }
            carsHtml = `<div class="flex justify-center w-full mt-3"><div class="flex gap-1 h-1.5 ${wrapperWidth}">${blocks}</div></div>`;
          }

          let contextHtml = "";
          if (t.context) {
            contextHtml = `
                    <div class="mt-3 context-grid text-[9px] text-zinc-500">
                        <div class="flex items-center justify-end gap-1 opacity-60">
                            ${t.context.prev ? `<span class="truncate max-w-[70px]">${t.context.prev.name}</span><span>-</span>` : ""}
                        </div>
                        <div class="flex flex-col items-center text-zinc-300 font-bold scale-110 justify-self-center min-w-[80px]">
                            <span>${t.context.curr.name}</span>
                        </div>
                        <div class="flex items-center justify-start gap-1 opacity-60">
                            ${t.context.next ? `<span>-</span><span class="truncate max-w-[70px]">${t.context.next.name}</span>` : ""}
                        </div>
                    </div>`;
          }

          const innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full border border-white/5 bg-white/5 text-zinc-400 tracking-wider uppercase">${t.op}</span>
                                <span class="text-[9px] font-mono text-zinc-500">#${t.num}</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="font-mono text-4xl font-medium tracking-tighter leading-none ${timeClass}" style="color: var(--text-primary)">${t.time}</span>
                                ${t.secTime ? `<span class="time-struck font-mono text-sm">${t.secTime}</span>` : ""}
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-end">
                            <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wide text-right truncate max-w-[100px]">${t.dest}</h3>
                            <div class="flex items-baseline mt-1 ${arrClass}">
                                <span class="text-[10px] text-zinc-600 mr-1">Chegada</span>
                                <span class="font-mono text-lg font-medium ${colorText}">${t.arr}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between gap-2 mb-1">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full ${dotClass}" ${pulseStyle}></div>
                            <span class="text-[10px] uppercase tracking-wide font-medium ${statusTextClass}">${t.status}</span>
                        </div>
                        <button onclick="openDetails('${t.id}')" class="text-[10px] font-medium text-zinc-500 hover:text-zinc-300 underline decoration-zinc-700 underline-offset-2 transition-colors">Ver Detalhes</button>
                    </div>

                    ${carsHtml}
                    ${contextHtml}
                `;

          const card = document.createElement("div");
          card.id = cardId;
          card.setAttribute("data-id", cardId);
          card.className = `glass-card rounded-2xl p-5 relative overflow-hidden group ${opacityClass}`;
          card.innerHTML = innerHTML;
          container.appendChild(card);
        });

        if (!window.hasScrolledNext && nextTrainIndex !== -1) {
          setTimeout(() => {
            const el = document.getElementById("next-divider");
            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
            window.hasScrolledNext = true;
          }, 500);
        }
      };

      window.loadMore = function () {
        displayLimit += 10;
        renderList(currentTrainList);
      };

      window.setStatus = function (s, msg) {
        const ping = document.getElementById("status-ping"),
          txt = document.getElementById("status-text");
        const icon = document.getElementById("refresh-icon");

        if (s === "loading") {
          icon.classList.add("animate-spin");
        } else if (s === "error" || s === "offline") {
          ping.className =
            "relative inline-flex h-1.5 w-1.5 rounded-full " +
            (s === "offline" ? "bg-zinc-500" : "bg-red-500");
          txt.innerText = msg || "Offline";
          icon.classList.remove("animate-spin");
        } else {
          ping.className =
            "relative inline-flex h-1.5 w-1.5 rounded-full bg-blue-500 dot-ping";
          txt.innerText = msg || "Online";
          document.getElementById("last-updated").innerText = new Date()
            .toLocaleTimeString("pt-PT")
            .substring(0, 5);
          icon.classList.remove("animate-spin");
        }
      };

      window.loadData = async function (silent = false) {
        if (isLoading) return;
        isLoading = true;
        if (!silent) setStatus("loading", "A atualizar...");
        else
          document.getElementById("refresh-icon").classList.add("animate-spin");

        try {
          if (!silent) await new Promise((r) => setTimeout(r, 300));
          const data = await getTrains();
          renderList(data);
          if (data.length > 0) setStatus("success");
          else if (activeTab === "lisboa") setStatus("offline", "Sem Dados");
          else setStatus("success", "Online");
        } catch (e) {
          console.error(e);
          setStatus("error");
        } finally {
          isLoading = false;
          if (window.lucide) lucide.createIcons();
        }
      };
      window.manualRefresh = function () {
        loadData(false);
      };

      window.switchTab = function (t) {
        // Swap Logic when switching tabs
        if (t !== activeTab) {
          const oldOrg = fertagusOrigin;
          fertagusOrigin = fertagusDest;
          fertagusDest = oldOrg;
        }

        activeTab = t;
        const isLisboa = t === "lisboa";

        const r = document.documentElement;
        // Always blue now
        r.style.setProperty("--accent", "#3b82f6");
        r.style.setProperty("--accent-dim", "rgba(59, 130, 246, 0.15)");
        document.getElementById("dest-display").className =
          "text-xl font-medium tracking-tight leading-none text-blue-500 station-name";
        document.getElementById("ambient-light").className =
          `fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] rounded-full blur-[120px] pointer-events-none transition-colors duration-1000 bg-blue-500/10`;

        const glider = document.getElementById("tab-glider");
        const btnLisboa = document.getElementById("tab-lisboa");
        const btnMargem = document.getElementById("tab-margem");

        if (isLisboa) {
          glider.style.transform = "translateX(0%)";
          btnLisboa.classList.add("active");
          btnMargem.classList.remove("active");
        } else {
          glider.style.transform = "translateX(100%)";
          btnLisboa.classList.remove("active");
          btnMargem.classList.add("active");
        }

        populateOriginSelect();
        updateDestinationOptions();
        validateRoute();
        updateStationLabels();
        saveState();

        document.getElementById("train-list").innerHTML = "";
        window.hasScrolledNext = false;

        document.getElementById("config-btn").classList.remove("hidden");
        document.getElementById("config-panel").classList.add("hidden");
        document.getElementById("next-train-header").classList.add("hidden"); // Reset header visibility

        loadData(false);
      };

      window.saveState = function () {
        localStorage.setItem("ft_org", fertagusOrigin);
        localStorage.setItem("ft_dst", fertagusDest);
        localStorage.setItem("ft_tab", activeTab);
      };

      // --- GLOBAL START ---
      window.onload = function () {
        init();
      };

      async function init() {
        if (checkMaintenanceMode()) return;

        setupPWA();
        loadSettings();

        try {
          const [resLisboa, resMargem] = await Promise.all([
            fetch("./json/fertagus_lisboa_semana.json"),
            fetch("./json/fertagus_margem_semana.json"),
          ]);

          if (resLisboa.ok) DB_LISBOA = await resLisboa.json();
          if (resMargem.ok) DB_MARGEM = await resMargem.json();
        } catch (e) {
          console.error("DB Load Error:", e);
          DB_LISBOA = { trips: [] };
          DB_MARGEM = { trips: [] };
        }

        // Determine Initial Tab based on Time & Settings if smart schedule enabled
        const nowH = new Date().getHours();

        let targetTab = "lisboa"; // Default
        if (enableSmartSchedule) {
          const morningPref = localStorage.getItem("pref_morning") || "lisboa";
          const afternoonPref =
            localStorage.getItem("pref_afternoon") || "margem";
          if (nowH >= 5 && nowH < 13) targetTab = morningPref;
          else if (nowH >= 13 || nowH < 2) targetTab = afternoonPref;
        } else {
          const savedTab = localStorage.getItem("ft_tab");
          if (savedTab) targetTab = savedTab;
        }

        activeTab = targetTab;

        loadStationPrefs(activeTab);

        // Removed validateRoute call here as per request to remove strict validation
        // Just rely on what's loaded or defaults

        // Events
        document
          .getElementById("sel-origin")
          .addEventListener("change", (e) => {
            fertagusOrigin = e.target.value;
            updateDestinationOptions();
            saveStationPrefs();
            updateStations();
          });

        document.getElementById("sel-dest").addEventListener("change", (e) => {
          fertagusDest = e.target.value;
          saveStationPrefs();
          updateStations();
        });

        populateOriginSelect();
        updateDestinationOptions();
        updateStationLabels();

        // Switch tab handles UI updates and data loading
        window.switchTab(activeTab);
        populateSettingsUI();

        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          if (!isLoading) loadData(true);
        }, 60000);

        if (nextTrainInterval) clearInterval(nextTrainInterval);
        nextTrainInterval = setInterval(updateNextCountdown, 1000);

        if (window.lucide) lucide.createIcons();
      }

      // --- C√ìDIGO NOVO: Calcular a Quinzena ---
      const agora = new Date();
      const dia = agora.getDate();
      const mes = agora.toLocaleString("pt-PT", { month: "long" });
      // P√µe a primeira letra do m√™s grande (janeiro -> Janeiro)
      const mesCapitalizado = mes.charAt(0).toUpperCase() + mes.slice(1);

      const parte = dia <= 15 ? "1.¬™" : "2.¬™";

      const titulo = document.getElementById("quinzena-titulo");
      if (titulo) {
        titulo.innerText = `Sugest√£o ‚Ä¢ ${parte} Quinzena de ${mesCapitalizado}`;
      }

      // --- L√≥gica do Cart√£o Spotify (Dados Mistos: Manual + Auto) ---
      const SPOTIFY_API_URL = "https://api.npoint.io/0f0a3c1ca3b044f666e8";

      async function loadSpotifyCard() {
        const container = document.getElementById("spotify-card-container");
        const coverImg = document.getElementById("sp-cover");
        const titleText = document.getElementById("sp-title");
        const artistText = document.getElementById("sp-artist");
        const btnLink = document.getElementById("sp-link");
        const badge = document.getElementById("quinzena-badge");

        try {
          // 1. Ler o JSON do npoint
          const response = await fetch(SPOTIFY_API_URL, { cache: "no-store" });
          if (!response.ok) return;
          const data = await response.json();

          if (data.album_id) {
            // --- A. DADOS MANUAIS (V√™m do teu JSON) ---

            // Artista (Garantido pelo teu JSON)
            if (data.artist_name) {
              artistText.innerText = data.artist_name;
            } else {
              artistText.innerText = "Spotify"; // Fallback se te esqueceres
            }

            // Link do Bot√£o
            const spotifyUrl = `https://open.spotify.com/album/${data.album_id}`;
            btnLink.href = spotifyUrl;

            // Badge da Quinzena
            const agora = new Date();
            const mes = agora
              .toLocaleString("pt-PT", { month: "short" })
              .replace(".", "");
            const mesCap = mes.charAt(0).toUpperCase() + mes.slice(1);
            const parte = agora.getDate() <= 15 ? "1.¬™" : "2.¬™";
            if (badge) badge.innerText = `${parte} Quiz. ${mesCap}`;

            // --- B. DADO AUTOM√ÅTICO (Apenas o T√≠tulo) ---
            // Vamos tentar buscar o t√≠tulo. Se falhar, pomos um gen√©rico.
            try {
              const oEmbedUrl = `https://open.spotify.com/oembed?url=${encodeURIComponent(spotifyUrl)}`;
              const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(oEmbedUrl)}`;

              const metaRes = await fetch(proxyUrl);

              if (metaRes.ok) {
                const meta = await metaRes.json();
                // O Spotify manda "T√≠tulo", mas √†s vezes √© "Artista - T√≠tulo"
                // Como tu j√° puseste o Artista manualmente, usamos o t√≠tulo direto
                titleText.innerText = meta.title || "Sugest√£o da Quinzena";
                coverImg.src = meta.thumbnail_url;
              } else {
                throw new Error("Falha no t√≠tulo autom√°tico");
              }
            } catch (titleError) {
              // Se o proxy falhar, usamos um t√≠tulo gen√©rico seguro
              console.warn("N√£o foi poss√≠vel obter o t√≠tulo autom√°tico.");
              titleText.innerText = "√Ålbum da Quinzena";
            }

            // Mostrar o cart√£o
            container.classList.remove("hidden");
            if (window.lucide) lucide.createIcons();
          }
        } catch (e) {
          console.error("Erro no widget:", e);
        }
      }

      document.addEventListener("DOMContentLoaded", loadSpotifyCard);
    </script>
  </body>
</html>
