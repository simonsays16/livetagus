<!doctype html>
<html lang="pt" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#09090b" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="description"
      content="LiveTagus - Monitorização em tempo real dos comboios da Fertagus. Veja horários, atrasos e supressões. App gratuita e open-source."
    />
    <meta name="robots" content="index, follow" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://livetagus.pt/" />
    <meta
      property="og:title"
      content="App LiveTagus | Fertagus em Tempo Real"
    />
    <meta
      property="og:description"
      content="LiveTagus - Monitorização em tempo real dos comboios da Fertagus. Veja horários, atrasos e supressões. App gratuita e open-source."
    />
    <meta
      property="og:image"
      content="https://livetagus.pt/imagens/logo_og.webp"
    />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://livetagus.pt/" />
    <meta
      property="twitter:title"
      content="App LiveTagus | Fertagus em Tempo Real"
    />
    <meta
      property="twitter:description"
      content="LiveTagus - Monitorização em tempo real dos comboios da Fertagus. Veja horários, atrasos e supressões. App gratuita e open-source."
    />
    <meta
      property="twitter:image"
      content="https://livetagus.pt/imagens/logo_og.webp"
    />
    <link
      rel="shortcut icon"
      href="./imagens/favicon-96x96.png"
      type="image/x-icon"
    />
    <title>App LiveTagus | Fertagus em Tempo Real</title>
    <link rel="stylesheet" href="./output.css" />
    <script src="./offline.js"></script>
    <script src="./menu.js" defer></script>
    <script src="./spotifycard.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /*body {
        overscroll-behavior-y: auto;
        overflow: hidden;
      }
      #train-container {
        overscroll-behavior-y: auto;
        -webkit-overflow-scrolling: touch;
      }*/
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes pulse-dot {
        0% {
          box-shadow: 0 0 0 0 var(--dot-color-glow, rgba(59, 130, 246, 0.5));
          opacity: 1;
        }
        70% {
          box-shadow: 0 0 0 6px transparent;
          opacity: 1;
        }
        to {
          box-shadow: 0 0 0 0 transparent;
          opacity: 1;
        }
      }
      .dot-ping {
        animation: pulse-dot 2s infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.6s ease-out forwards;
      }

      .mask-gradient {
        -webkit-mask-image: linear-gradient(180deg, #000 90%, transparent);
        mask-image: linear-gradient(180deg, #000 90%, transparent);
      }

      /* Custom Select Styles */
      .select-header {
        appearance: none;
        background-color: transparent;
        border: none;
        padding: 0;
        margin: 0;
        font-family: inherit;
        font-size: inherit;
        cursor: pointer;
        line-height: 1;
        outline: none;
        width: 100%;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
      }
      .select-header option {
        background-color: #09090b;
        color: white;
      }

      /* Light mode option override */
      :root:not(.dark) .select-header option {
        background-color: #ffffff;
        color: #000000;
      }
    </style>
    <script>
      window.lucide = {
        createIcons: () => {
          const icons = {
            moon: '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>',
            "arrow-right": '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            "arrow-right-left":
              '<path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/>',
            "refresh-cw":
              '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            x: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
            "train-track":
              '<path d="M2 17 17 2"/><path d="m2 14 8 8"/><path d="m5 11 8 8"/><path d="m8 8 8 8"/><path d="m11 5 8 8"/><path d="m14 2 8 8"/><path d="M7 22 22 7"/>',
            info: '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>',
            "alert-triangle":
              '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>',
            "gamepad-2":
              '<line x1="6" x2="10" y1="12" y2="12"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="15" x2="15.01" y1="13" y2="13"/><line x1="18" x2="18.01" y1="11" y2="11"/><rect width="20" height="12" x="2" y="6" rx="2"/>',
            download:
              '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>',
            "chevron-down": '<path d="m6 9 6 6 6-6"/>',
          };

          document.querySelectorAll("[data-lucide]").forEach((element) => {
            const key = element.getAttribute("data-lucide");
            if (!icons[key]) return;

            const svg = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "svg",
            );
            svg.setAttribute("width", "24");
            svg.setAttribute("height", "24");
            svg.setAttribute("viewBox", "0 0 24 24");
            svg.setAttribute("fill", "none");
            svg.setAttribute("stroke", "currentColor");
            svg.setAttribute("stroke-width", "2");
            svg.setAttribute("stroke-linecap", "round");
            svg.setAttribute("stroke-linejoin", "round");
            const currentClasses = element.getAttribute("class") || "";
            svg.setAttribute(
              "class",
              `lucide lucide-${key} ${currentClasses}`.trim(),
            );
            if (element.id) svg.setAttribute("id", element.id);
            svg.innerHTML = icons[key];
            element.parentNode.replaceChild(svg, element);
          });
        },
      };
    </script>
  </head>
  <body
    class="h-[100dvh] flex flex-col bg-zinc-50 dark:bg-[#09090b] text-zinc-900 dark:text-zinc-200 font-sans transition-colors duration-300 selection:bg-blue-500/30 overflow-hidden"
  >
    <div id="global-nav"></div>

    <!-- Background Ambient Light -->
    <div
      id="ambient-light"
      class="fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[600px] bg-blue-500/10 rounded-full blur-[120px] pointer-events-none transition-colors duration-1000"
    ></div>

    <!-- Main Container -->
    <main
      class="relative top-0 z-10 w-full max-w-md mx-auto flex flex-col flex-1 pt-[calc(4.5rem+env(safe-area-inset-top))] overflow-hidden"
      role="main"
    >
      <!-- Compact Header Area (One Line) -->
      <div class="sticky top-1 px-6 pt-2 pb-3 z-30 flex flex-col flex-none">
        <div class="flex items-center justify-between w-full gap-2 relative">
          <!-- Origin Select -->
          <div class="flex-1 min-w-0 relative group">
            <label
              for="sel-origin"
              class="text-[9px] font-bold uppercase tracking-wider text-zinc-400 absolute -top-3 left-0"
            >
              Partida
            </label>
            <select
              id="sel-origin"
              onchange="(handleOriginChange(), manualRefresh)"
              class="select-header text-xl font-bold tracking-tight text-zinc-900 dark:text-zinc-100 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors cursor-pointer py-0 pr-4"
              aria-label="Selecione a estação de partida"
            ></select>
            <i
              data-lucide="chevron-down"
              class="w-3.5 h-3.5 absolute right-0 top-1/2 -translate-y-1/2 text-zinc-400 pointer-events-none opacity-50 group-hover:opacity-100 transition-opacity"
            ></i>
          </div>

          <!-- Swap Button -->
          <button
            onclick="(swapStations(), manualRefresh)"
            class="shrink-0 p-2 rounded-full bg-zinc-100 dark:bg-white/5 text-zinc-500 dark:text-zinc-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors active:scale-90 relative top-1"
            aria-label="Trocar estações de partida e destino"
          >
            <i data-lucide="arrow-right-left" class="w-3.5 h-3.5"></i>
          </button>

          <!-- Destination Select -->
          <div class="flex-1 min-w-0 relative group text-right">
            <label
              for="sel-dest"
              class="text-[9px] font-bold uppercase tracking-wider text-zinc-400 absolute -top-3 right-0"
            >
              Destino
            </label>
            <select
              id="sel-dest"
              onchange="(handleDestChange(), manualRefresh)"
              class="select-header text-xl font-bold tracking-tight text-blue-500 hover:text-blue-400 transition-colors cursor-pointer py-0 pl-4 text-right"
              dir="rtl"
              aria-label="Selecione a estação de destino"
            ></select>
            <i
              data-lucide="chevron-down"
              class="w-3 h-3 absolute left-0 top-1/2 -translate-y-1/2 text-blue-500/50 pointer-events-none opacity-50 group-hover:opacity-100 transition-opacity"
            ></i>
          </div>
        </div>

        <!-- Compact Next Train Countdown -->
        <div
          id="next-train-header"
          class="hidden opacity-0 transition-opacity duration-500 mt-3"
        >
          <div class="flex items-center gap-2 text-xs">
            <div
              class="flex items-baseline gap-1.5 px-2.5 py-1 rounded-md bg-zinc-100 dark:bg-white/5 border border-zinc-200 dark:border-white/5"
            >
              <span
                class="uppercase tracking-widest text-[9px] font-bold text-zinc-500"
              >
                Próximo
              </span>
              <span
                id="countdown-display"
                class="font-mono font-bold text-blue-500"
              >
                -- min -- s
              </span>
            </div>

            <!-- Live Status Indicator -->
            <div class="flex items-center gap-1.5 ml-auto opacity-70">
              <span
                id="status-ping"
                class="relative inline-flex h-1.5 w-1.5 rounded-full bg-blue-500"
              ></span>
              <span
                id="last-updated"
                class="text-[9px] font-mono text-zinc-400 leading-none"
              >
                --:--
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Train List Area -->
      <div
        id="train-container"
        class="flex-grow overflow-y-auto px-6 pt-2 scrollbar-hide mask-gradient"
      >
        <div id="train-list" class="space-y-3 pb-12"></div>
        <button
          id="load-more-btn"
          onclick="loadMore()"
          class="hidden w-full pb-12 text-xs font-bold uppercase tracking-widest text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-300 transition-colors text-center"
        >
          Ver Mais Comboios
        </button>
        <div
          class="flex items-center gap-4 pb-2 opacity-80 scroll-mt-[180px]"
          id="next-divider"
        >
          <div
            class="flex-1 h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"
          ></div>
          <span
            class="text-[0.65rem] font-extrabold uppercase tracking-[0.2em] text-blue-500 whitespace-nowrap"
          >
            A nossa sugestão para a Viagem
          </span>
          <div
            class="flex-1 h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"
          ></div>
        </div>

        <!-- Spotify Card -->
        <div
          id="spotify-card-container"
          class="bg-white/90 dark:bg-zinc-800/40 backdrop-blur-sm border border-black/5 dark:border-white/5 shadow-lg rounded-2xl overflow-hidden mb-8 mt-4 hidden animate-fade-in w-full relative group"
        >
          <div class="flex h-36">
            <div
              class="w-36 h-36 shrink-0 relative bg-zinc-800 border-r border-white/5"
            >
              <img
                id="sp-cover"
                src="./imagens/icon.svg"
                class="absolute inset-0 w-full h-full object-cover"
                alt="Capa do Álbum"
                width="144"
                height="144"
                loading="lazy"
              />
            </div>

            <div class="flex-1 p-3 flex flex-col justify-between min-w-0">
              <div>
                <div class="flex items-center justify-between mb-1">
                  <span
                    id="quinzena-badge"
                    class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-white/5 border border-white/10 text-zinc-400 tracking-wider uppercase"
                  >
                    Quinzena Atual
                  </span>
                </div>

                <h2
                  id="sp-title"
                  class="text-base font-bold text-zinc-900 dark:text-zinc-100 leading-tight line-clamp-2 mt-1"
                >
                  A carregar...
                </h2>

                <p
                  id="sp-artist"
                  class="text-xs text-zinc-400 font-medium truncate mt-1"
                >
                  Spotify
                </p>
              </div>

              <a
                id="sp-link"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                class="mt-2 flex items-center justify-center gap-2 w-full py-2 bg-[#1DB954] hover:bg-[#1ed760] text-black rounded-lg transition-all active:scale-95"
                aria-label="Ouvir no Spotify"
              >
                <svg class="w-4 h-4 fill-black shrink-0" viewBox="0 0 24 24">
                  <path
                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"
                  />
                </svg>
                <span
                  class="text-[10px] font-bold uppercase tracking-widest truncate"
                >
                  Ouvir no Spotify
                </span>
              </a>
            </div>
          </div>
        </div>
        <div id="global-footer"></div>
      </div>

      <!-- Train Details Modal -->
      <div
        id="train-details-modal"
        class="fixed inset-x-0 bottom-0 h-[85vh] bg-white/85 dark:bg-[#09090b]/95 backdrop-blur-xl border-t border-black/5 dark:border-white/10 rounded-t-[2rem] z-50 transform translate-y-full transition-transform duration-300 flex flex-col shadow-2xl overflow-hidden"
      >
        <!-- Content Injected via JS -->
      </div>

      <div
        id="modal-backdrop"
        onclick="closeDetails()"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"
      ></div>
    </main>

    <!-- Hidden HTML Templates for Menu Injection -->
    <div id="menu-settings-template" class="hidden">
      <div
        class="mt-8 pt-8 border-t border-zinc-200 dark:border-white/10 space-y-6"
      >
        <!-- Regular Stations -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <span
              class="text-xs font-bold tracking-widest text-zinc-500 uppercase"
            >
              Estações Regulares (Fase de Testes)
            </span>
            <button
              id="toggle-regular"
              onclick="toggleRegularStations()"
              class="w-10 h-5 rounded-full relative transition-colors cursor-pointer bg-zinc-600"
              aria-label="Alternar estações regulares"
            >
              <div
                class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 toggle-dot"
              ></div>
            </button>
          </div>

          <div
            id="regular-stations-content"
            class="bg-zinc-100 dark:bg-zinc-800/50 rounded-xl p-4 space-y-4 opacity-50 pointer-events-none transition-opacity"
          >
            <div class="flex items-center justify-between">
              <span
                class="text-xs font-medium text-zinc-900 dark:text-zinc-100"
              >
                Usar Mesmas Estações (Invertidas)
              </span>
              <button
                id="btn-sync-stations"
                onclick="toggleSyncStations()"
                class="w-8 h-4 rounded-full relative transition-colors cursor-pointer bg-zinc-600"
                aria-label="Sincronizar estações"
              >
                <div
                  class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-transform duration-300 toggle-dot"
                ></div>
              </button>
            </div>

            <div
              class="space-y-3 pt-2 border-t border-black/5 dark:border-white/10"
            >
              <p
                class="text-[9px] uppercase font-bold text-zinc-500 dark:text-zinc-400"
              >
                Sentido Lisboa
              </p>
              <div class="grid grid-cols-2 gap-2">
                <select
                  id="set-lisboa-org"
                  class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-2 text-xs w-full text-zinc-900 dark:text-zinc-100"
                  onchange="saveRegularStations()"
                  aria-label="Partida Lisboa"
                ></select>
                <select
                  id="set-lisboa-dest"
                  class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-2 text-xs w-full text-zinc-900 dark:text-zinc-100"
                  onchange="saveRegularStations()"
                  aria-label="Destino Lisboa"
                ></select>
              </div>
            </div>

            <div
              id="settings-margem-group"
              class="space-y-3 pt-2 border-t border-black/5 dark:border-white/10 hidden"
            >
              <p
                class="text-[9px] uppercase font-bold text-zinc-500 dark:text-zinc-400"
              >
                Sentido Margem
              </p>
              <div class="grid grid-cols-2 gap-2">
                <select
                  id="set-margem-org"
                  class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-2 text-xs w-full text-zinc-900 dark:text-zinc-100"
                  onchange="saveRegularStations()"
                  aria-label="Partida Margem"
                ></select>
                <select
                  id="set-margem-dest"
                  class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-2 text-xs w-full text-zinc-900 dark:text-zinc-100"
                  onchange="saveRegularStations()"
                  aria-label="Destino Margem"
                ></select>
              </div>
            </div>
          </div>
        </div>

        <!-- Smart Schedule -->
        <div>
          <div class="flex justify-between items-center mb-3">
            <span
              class="text-xs font-bold tracking-widest text-zinc-500 uppercase"
            >
              Horário Inteligente (Fase de Testes)
            </span>
            <button
              id="toggle-smart"
              onclick="toggleSmartSchedule()"
              class="w-10 h-5 rounded-full relative transition-colors cursor-pointer bg-zinc-600"
              aria-label="Alternar horário inteligente"
            >
              <div
                class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 toggle-dot"
              ></div>
            </button>
          </div>

          <div
            id="smart-schedule-content"
            class="bg-zinc-100 dark:bg-zinc-800/50 rounded-xl p-4 space-y-4 opacity-50 pointer-events-none transition-opacity"
          >
            <div class="flex items-center justify-between">
              <span
                class="text-xs font-medium text-zinc-900 dark:text-zinc-100"
              >
                Manhã (05:30 - 13:00)
              </span>
              <select
                id="smart-morning"
                class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-1.5 text-xs w-28 text-zinc-900 dark:text-zinc-100"
                onchange="saveSmartSchedule()"
                aria-label="Sentido Manhã"
              >
                <option value="lisboa">Sentido Lisboa</option>
                <option value="margem">Sentido Margem</option>
              </select>
            </div>
            <div
              class="flex items-center justify-between border-t border-black/5 dark:border-white/10 pt-3"
            >
              <span
                class="text-xs font-medium text-zinc-900 dark:text-zinc-100"
              >
                Tarde (13:00 - 02:00)
              </span>
              <select
                id="smart-afternoon"
                class="bg-white/50 dark:bg-black/20 border border-black/5 dark:border-white/10 rounded-lg p-1.5 text-xs w-28 text-zinc-900 dark:text-zinc-100"
                onchange="saveSmartSchedule()"
                aria-label="Sentido Tarde"
              >
                <option value="margem">Sentido Margem</option>
                <option value="lisboa">Sentido Lisboa</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const PROXY = "https://corsproxy.io/?";
      const API_FERTAGUS_NEW = "https://api.livetagus.pt/fertagus/";
      // Added timestamp to bust cache
      const API_ALERTS = "https://api.npoint.io/fe6b8c687169feff5f87";

      const FERTAGUS_STATIONS = [
        { id: "9468122", key: "setubal", name: "Setúbal" },
        { id: "9468098", key: "palmela", name: "Palmela" },
        { id: "9468049", key: "venda_do_alcaide", name: "Venda do Alcaide" },
        { id: "9468007", key: "pinhal_novo", name: "Pinhal Novo" },
        { id: "9417095", key: "penalva", name: "Penalva" },
        { id: "9417236", key: "coina", name: "Coina" },
        { id: "9417186", key: "fogueteiro", name: "Fogueteiro" },
        { id: "9417152", key: "foros_de_amora", name: "Foros de Amora" },
        { id: "9417137", key: "corroios", name: "Corroios" },
        { id: "9417087", key: "pragal", name: "Pragal" },
        { id: "9467033", key: "campolide", name: "Campolide" },
        { id: "9466076", key: "sete_rios", name: "Sete Rios" },
        { id: "9466050", key: "entrecampos", name: "Entrecampos" },
        { id: "9466035", key: "roma_areeiro", name: "Roma-Areeiro" },
      ];

      let DB_LISBOA = null;
      let DB_MARGEM = null;
      let deferredPrompt;

      // --- STATE ---
      let activeTab = "lisboa";
      let isLoading = false;
      let fertagusOrigin = "corroios";
      let fertagusDest = "roma_areeiro";
      let refreshInterval = null;
      let nextTrainInterval = null;
      let isDarkMode = true;
      let currentTrainList = [];
      let displayLimit = 10;
      let nextTrainDate = null;
      let syncStations = true;

      let enableRegularStations = false;
      let enableSmartSchedule = false;

      let activeAlerts = [];

      // --- CRITICAL FUNCTIONS DEFINED GLOBALLY ---

      window.setTheme = function (mode) {
        currentTheme = mode;
        localStorage.setItem("theme", mode);
        applyTheme();
      };

      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          if (currentTheme === "system") applyTheme();
        });

      window.applyTheme = function () {
        let effectiveDark = false;
        if (currentTheme === "system") {
          effectiveDark = window.matchMedia(
            "(prefers-color-scheme: dark)",
          ).matches;
        } else {
          effectiveDark = currentTheme === "dark";
        }
        isDarkMode = effectiveDark;

        // Toggle class 'dark' on html element
        if (isDarkMode) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        // Update menu buttons visual state
        document.querySelectorAll(".theme-btn").forEach((btn) => {
          btn.classList.remove(
            "font-bold",
            "text-black",
            "dark:text-white",
            "bg-black/5",
            "dark:bg-white/10",
          );
          if (btn.dataset.mode === currentTheme) {
            btn.classList.add(
              "font-bold",
              "text-black",
              "dark:text-white",
              "bg-black/5",
              "dark:bg-white/10",
            );
          }
        });

        // --- UPDATE LOGOS & BADGES (Replicating menu.js logic) ---
        const navLogo = document.getElementById("nav-logo");
        const footerLogo = document.getElementById("footer-logo");
        const netlifyBadgeMenu = document.getElementById("netlify-badge-menu");
        const netlifyBadgeFooter = document.getElementById(
          "netlify-badge-footer",
        );

        const logoLight = "./imagens/logotransparente.svg";
        const logoDark = "./imagens/icon.svg";
        const badgeDark =
          "https://www.netlify.com/img/global/badges/netlify-dark.svg";
        const badgeLight =
          "https://www.netlify.com/img/global/badges/netlify-light.svg";

        if (isDarkMode) {
          if (navLogo) navLogo.src = logoDark;
          if (footerLogo) footerLogo.src = logoDark;
          if (netlifyBadgeMenu) netlifyBadgeMenu.src = badgeDark;
          if (netlifyBadgeFooter) netlifyBadgeFooter.src = badgeDark;
        } else {
          if (navLogo) navLogo.src = logoLight;
          if (footerLogo) footerLogo.src = logoLight;
          if (netlifyBadgeMenu) netlifyBadgeMenu.src = badgeLight;
          if (netlifyBadgeFooter) netlifyBadgeFooter.src = badgeLight;
        }
      };

      // Helper to calculate direction based on indices
      function calculateDirection(orgKey, dstKey) {
        const orgIdx = FERTAGUS_STATIONS.findIndex((s) => s.key === orgKey);
        const dstIdx = FERTAGUS_STATIONS.findIndex((s) => s.key === dstKey);
        if (orgIdx === -1 || dstIdx === -1) return "lisboa"; // fallback

        // 0 = Setubal (South), 13 = Roma-Areeiro (North)
        // If moving towards higher index -> North -> Lisboa
        if (orgIdx < dstIdx) return "lisboa";
        return "margem";
      }

      function focusOnContent() {
        // Delay slightly to ensure rendering is complete
        // Prioritize alerts container, fallback to divider
        const alerts = document.getElementById("alerts-dynamic-container");
        const divider = document.getElementById("next-divider");

        if (alerts) {
          alerts.scrollIntoView({ behavior: "smooth", block: "start" });
        } else if (divider) {
          divider.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        console.log("focus on content called");
      }

      window.handleOriginChange = function () {
        const orgSel = document.getElementById("sel-origin");
        if (!orgSel) return;

        fertagusOrigin = orgSel.value;

        // Update destination options to exclude new origin
        populateDestSelect(fertagusOrigin);

        // If current dest is same as new origin, we must change it
        if (fertagusDest === fertagusOrigin) {
          const dstSel = document.getElementById("sel-dest");
          // Pick first available option
          if (dstSel && dstSel.options.length > 0) {
            fertagusDest = dstSel.options[0].value;
            dstSel.value = fertagusDest;
          }
        } else {
          // Ensure dropdown visual matches state
          const dstSel = document.getElementById("sel-dest");
          if (dstSel) dstSel.value = fertagusDest;
        }

        updateAppState();
        setTimeout(focusOnContent(), 1000);
      };

      window.handleDestChange = function () {
        const dstSel = document.getElementById("sel-dest");
        if (!dstSel) return;

        fertagusDest = dstSel.value;
        updateAppState();
      };

      window.swapStations = function () {
        const temp = fertagusOrigin;
        fertagusOrigin = fertagusDest;
        fertagusDest = temp;

        // Sync UI
        const orgSel = document.getElementById("sel-origin");
        if (orgSel) orgSel.value = fertagusOrigin;

        populateDestSelect(fertagusOrigin);

        const dstSel = document.getElementById("sel-dest");
        if (dstSel) dstSel.value = fertagusDest;

        updateAppState();
      };

      function updateAppState() {
        // Calculate direction
        const newDirection = calculateDirection(fertagusOrigin, fertagusDest);
        if (newDirection !== activeTab) {
          activeTab = newDirection;
        }

        saveState();
        loadData();
        setTimeout(() => {
          focusOnContent();
        }, 800);
      }

      // Ensure validateRoute exists (legacy support)
      window.validateRoute = function () {
        return true;
      };

      window.populateOriginSelect = function () {
        const orgSel = document.getElementById("sel-origin");
        if (!orgSel) return;

        // Mostra SEMPRE todas as estações na origem, independentemente do sentido
        // Usamos uma cópia para não inverter o array original
        const allStations = [FERTAGUS_STATIONS];

        // Se quiseres que a ordem faça sentido visual com o separador:

        orgSel.innerHTML = allStations
          .map(
            (allStations) =>
              `<option value="${allStations.key}">${allStations.name}</option>`,
          )
          .join("");

        orgSel.value = fertagusOrigin;

        // O destino sim, deve ser filtrado com base na origem escolhida
        updateDestinationOptions();
      };

      window.populateDestSelect = function (currentOrigin) {
        const dstSel = document.getElementById("sel-dest");
        if (!dstSel) return;

        // Dest can be any station EXCEPT current origin
        const validDests = FERTAGUS_STATIONS.filter(
          (s) => s.key !== currentOrigin,
        );
        dstSel.innerHTML = validDests
          .map((s) => `<option value="${s.key}">${s.name}</option>`)
          .join("");

        // Try to keep current selection if valid
        if (validDests.find((s) => s.key === fertagusDest)) {
          dstSel.value = fertagusDest;
        } else {
          // Default to first if invalid
          if (validDests.length > 0) {
            // Logic to pick reasonable default: usually farthest
            // But simple approach first item is fine as user just changed origin
            fertagusDest = validDests[0].key;
            dstSel.value = fertagusDest;
          }
        }
      };

      // Legacy function name mapping for compatibility
      window.updateStations = function () {
        handleOriginChange();
      };
      window.updateDestinationOptions = function () {
        populateDestSelect(fertagusOrigin);
      };
      window.updateStationLabels = function () {}; // No-op now as UI is selects

      window.parseTimeStr = function (str) {
        if (!str) return null;
        const [h, m] = str.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        if (d < new Date(Date.now() - 4 * 3600000)) d.setDate(d.getDate() + 1);
        return d;
      };

      window.addMinutes = function (str, min) {
        const d = parseTimeStr(str);
        if (!d) return "--:--";
        d.setMinutes(d.getMinutes() + min);
        return d.toLocaleTimeString("pt-PT", {
          hour: "2-digit",
          minute: "2-digit",
        });
      };

      window.updateNextCountdown = function () {
        if (!nextTrainDate) {
          document
            .getElementById("next-train-header")
            .classList.add("opacity-0", "hidden");
          return;
        }
        const now = new Date();
        let diff = Math.floor((nextTrainDate - now) / 1000);
        if (diff < 0) diff = 0;
        const min = Math.floor(diff / 60);
        const sec = Math.floor((diff % 60) / 10) * 10;
        document.getElementById("countdown-display").innerText =
          `${min} min ${sec.toString().padStart(2, "0")} s`;
        const header = document.getElementById("next-train-header");
        header.classList.remove("hidden");
        requestAnimationFrame(() => header.classList.remove("opacity-0"));
      };

      // --- ALERTS SYSTEM ---
      const AlertsManager = {
        fetch: async () => {
          try {
            // Added cache buster
            const res = await fetch(API_ALERTS + "?t=" + Date.now());
            if (!res.ok) return [];
            const data = await res.json();
            return Object.values(data);
          } catch (e) {
            console.error(e);
            return [];
          }
        },

        parseDatePT: (str) => {
          if (!str || typeof str !== "string" || !str.includes("/"))
            return null;
          const [d, m, y] = str.split("/");
          const date = new Date(y, m - 1, d);
          date.setHours(0, 0, 0, 0);
          return date;
        },

        isActive: (alert) => {
          const now = new Date();
          now.setHours(0, 0, 0, 0);

          if (alert.datainicio && alert.datainicio.trim() !== "") {
            const start = AlertsManager.parseDatePT(alert.datainicio);
            if (start && now < start) return false;
          }

          if (alert.datafim && alert.datafim.trim() !== "") {
            const end = AlertsManager.parseDatePT(alert.datafim);
            if (end && now > end) return false;
          }
          return true;
        },

        checkSudoku: (trains) => {
          // Se não houver comboios nenhuns (fim do dia, offline, etc), não mostra
          if (!trains || trains.length === 0) return null;

          // 1. Encontra o próximo comboio efetivo (o primeiro que ainda não passou)
          let nextTrain = trains.find(
            (t) => t.isEffectiveFuture && !t.isSuppressed,
          );

          // Fallbacks de segurança caso seja o fim do dia
          if (!nextTrain) nextTrain = trains.find((t) => !t.isSuppressed);
          if (!nextTrain) nextTrain = trains[0];

          // 2. RETORNA SEMPRE O AVISO (VERSÃO DE TESTE)
          if (nextTrain) {
            return {
              id: "sudoku-promo",
              tipo: "informacao",
              nome: "Tempo de Espera?",
              mensagem: "Aborrecido? Joga Sudoku!",
              textolink: "Jogar",
              isSudoku: true,
              icon: "gamepad-2",
              // Guarda a info extra do próximo comboio para o botão do Sudoku
              trainId: nextTrain.id,
              trainDest: nextTrain.dest,
            };
          }

          return null;
        },

        checkPWA: () => {
          const isStandalone = window.matchMedia(
            "(display-mode: standalone)",
          ).matches;
          const dismissed = sessionStorage.getItem("pwa_dismissed");

          if (!isStandalone && !dismissed) {
            return {
              id: "pwa-install",
              tipo: "informacao",
              nome: "Instalar App",
              mensagem: "Para acesso rápido e direto.",
              textolink: "Instalar",
              isPWA: true,
              icon: "download",
            };
          }
          return null;
        },

        generateHTML: (alerts) => {
          if (!alerts || alerts.length === 0) return "";

          // 1. Container e Slider Track
          let html =
            '<div id="alerts-dynamic-container" class="mt-4 mb-1 relative group w-full animate-fade-in">';

          // flex-nowrap: Garante linha única
          // overflow-x-auto: Permite scroll
          html +=
            '<div id="alerts-slider" class="w-full flex flex-nowrap gap-3 overflow-x-auto snap-x snap-mandatory scrollbar-hide py-1">';

          alerts.forEach((alert, index) => {
            const isWarning = alert.tipo === "aviso";

            // Definição de estilos condicionais (rápida)
            const bgColor = isWarning
              ? "bg-amber-500/10 dark:bg-amber-500/5"
              : "bg-white/90 dark:bg-zinc-800/40";
            const borderColor = isWarning
              ? "border-amber-500/30"
              : "border-black/5 dark:border-white/5";
            const iconColor = isWarning ? "text-amber-500" : "text-blue-500";
            const lucideIcon = alert.icon
              ? alert.icon
              : isWarning
                ? "alert-triangle"
                : "info";

            // Lógica do botão de ação
            let actionHtml = "";
            if (alert.isPWA) {
              actionHtml = `<button onclick="installPWA()" class="ml-auto shrink-0 text-[9px] font-bold uppercase tracking-wider text-white bg-blue-600 px-3 py-1.5 rounded transition-colors shadow-sm active:scale-95">Instalar</button>`;
            } else if (alert.link && alert.link !== "#" && !alert.isSudoku) {
              const txt = alert.textolink || "Ver";
              actionHtml = `<a href="${alert.link}" target="_blank" class="ml-auto shrink-0 text-[9px] font-bold uppercase tracking-wider text-blue-500 border border-blue-500/30 px-3 py-1.5 rounded transition-colors active:scale-95">${txt}</a>`;
            } else if (alert.isSudoku) {
              actionHtml = `<a href="./sudoku.html" class="ml-auto shrink-0 text-[9px] font-bold uppercase tracking-wider text-white bg-[var(--accent,#3b82f6)] px-3 py-1.5 rounded transition-transform active:scale-95 shadow-sm">Jogar</a>`;
            }

            // O Card (w-full flex-none snap-center é o segredo do layout)
            html += `
                <div id="alert-${index}" class="w-full flex-none snap-center h-16 ${bgColor} backdrop-blur-sm border ${borderColor} rounded-xl px-4 flex items-center gap-3 shadow-sm relative pr-10">
                    <div class="shrink-0">
                        <i data-lucide="${lucideIcon}" class="w-5 h-5 ${iconColor}"></i>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center pr-2">
                        <h3 class="text-xs font-bold text-zinc-800 dark:text-zinc-200 leading-none truncate mb-1">${alert.nome}</h3>
                        <p class="text-[10px] text-zinc-500 dark:text-zinc-400 leading-tight line-clamp-2">${alert.mensagem}</p>
                    </div>
                    <div class="flex items-center self-center">
                        ${actionHtml}
                    </div>
                    <button onclick="AlertsManager.dismiss(${index}, '${alert.id}')" class="absolute top-2 right-2 p-1.5 bg-black/5 dark:bg-white/5 hover:bg-black/10 dark:hover:bg-white/10 rounded-full text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 transition-colors z-10" aria-label="Fechar aviso">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `;
          });

          html += "</div>"; // Fecha Slider Track

          // Paginação (Dots)
          if (alerts.length > 1) {
            html +=
              '<div id="alerts-pagination" class="flex justify-center gap-1 mt-1.5">';
            alerts.forEach((_, i) => {
              const activeClass =
                i === 0
                  ? "bg-blue-500 w-3"
                  : "bg-zinc-300 dark:bg-zinc-700 w-1.5";
              html += `<div class="h-1.5 rounded-full transition-all duration-300 ${activeClass}" data-index="${i}"></div>`;
            });
            html += "</div>";
          }

          html += "</div>"; // Fecha Container Principal
          return html;
        },
        dismiss: (index, id) => {
          const el = document.getElementById(`alert-${index}`);
          if (el) el.remove();
          if (id === "pwa-install")
            sessionStorage.setItem("pwa_dismissed", "true");
          const container = document.getElementById("alerts-slider");
          if (!container || container.children.length === 0) {
            const wrapper = document.getElementById("alerts-dynamic-container");
            if (wrapper) wrapper.remove();
          } else {
            const dots = document.getElementById("alerts-pagination");
            if (dots && dots.lastChild) dots.lastChild.remove();
          }
        },
      };

      async function updateAlertsSystem(trainList) {
        let tempAlerts = [];
        const pwa = AlertsManager.checkPWA();
        if (pwa) tempAlerts.push(pwa);
        const sudoku = AlertsManager.checkSudoku(trainList);
        if (sudoku) tempAlerts.push(sudoku);
        const external = await AlertsManager.fetch();
        external.forEach((alert) => {
          if (AlertsManager.isActive(alert)) {
            tempAlerts.push(alert);
          }
        });
        tempAlerts.sort((a, b) => {
          if (a.tipo === "aviso" && b.tipo !== "aviso") return -1;
          if (a.tipo !== "aviso" && b.tipo === "aviso") return 1;
          return 0;
        });
        activeAlerts = tempAlerts;
      }

      // --- MENU INTEGRATION LOGIC ---
      function injectCustomMenuElements() {
        // 1. Inject Settings
        const menuOverlay = document.getElementById("menu-overlay");
        const settingsTemplate = document.getElementById(
          "menu-settings-template",
        );

        if (menuOverlay && settingsTemplate) {
          const nav = menuOverlay.querySelector("nav");
          if (nav) {
            // Create container for new settings after nav
            const container = document.createElement("div");
            container.innerHTML = settingsTemplate.innerHTML;
            nav.parentNode.insertBefore(container, nav.nextSibling);

            // Initialize settings UI
            populateSettingsUI();

            // FIX: Remove the template source to prevent duplicate IDs in the DOM
            settingsTemplate.remove();
          }
        }

        // 2. Inject Refresh Button CORRECTLY (Left of Trigger)
        const header = document.querySelector("#global-nav header");
        const trigger = document.getElementById("menu-trigger");

        if (
          header &&
          trigger &&
          !document.getElementById("menu-controls-wrapper")
        ) {
          // Create wrapper for controls
          const wrapper = document.createElement("div");
          wrapper.id = "menu-controls-wrapper";
          wrapper.className = "flex items-center gap-1";

          // Move trigger inside wrapper
          header.insertBefore(wrapper, trigger);
          wrapper.appendChild(trigger);

          // Create refresh button
          const btn = document.createElement("button");
          btn.onclick = manualRefresh;
          btn.className =
            "p-2 rounded-full transition-colors text-zinc-900 dark:text-white group";
          btn.setAttribute("aria-label", "Atualizar");
          btn.innerHTML = `<i data-lucide="refresh-cw" id="refresh-icon-menu" class="w-5 h-5 transition-transform group-active:scale-90"></i>`;

          // Insert refresh button BEFORE trigger inside wrapper
          wrapper.insertBefore(btn, trigger);

          if (window.lucide) lucide.createIcons();
        }

        // Inject Legal Warning Footer
        const footer = document.getElementById("global-footer");
        if (footer) {
          const p = document.createElement("p");
          p.className =
            "text-[0.6rem] text-center text-zinc-500 dark:text-zinc-400 mb-6 opacity-60 block w-full px-4";
          p.innerText =
            "Atenção: Os horários e estado de circulação podem sofrer alterações sem aviso prévio. Esteja na estação à hora programada.";
          footer.insertBefore(p, footer.firstChild);
        }
      }

      // --- FUNCTIONS DECLARATIONS ---

      window.loadSettings = function () {
        const savedTheme = localStorage.getItem("theme");
        setTheme(savedTheme || "system");

        enableRegularStations =
          localStorage.getItem("enable_regular") === "true";
        enableSmartSchedule = localStorage.getItem("enable_smart") === "true";

        const savedSync = localStorage.getItem("pref_sync_stations");
        syncStations = savedSync === "false" ? false : true;

        updateSettingsToggles();
      };

      window.loadStationPrefs = function (direction) {
        if (!enableRegularStations) return;
        const savedOrg = localStorage.getItem(`pref_${direction}_org`);
        const savedDest = localStorage.getItem(`pref_${direction}_dest`);

        if (savedOrg && FERTAGUS_STATIONS.find((s) => s.key === savedOrg))
          fertagusOrigin = savedOrg;
        if (savedDest && FERTAGUS_STATIONS.find((s) => s.key === savedDest))
          fertagusDest = savedDest;
      };

      window.saveStationPrefs = function () {
        if (!enableRegularStations) return;
        localStorage.setItem(`pref_${activeTab}_org`, fertagusOrigin);
        localStorage.setItem(`pref_${activeTab}_dest`, fertagusDest);

        if (syncStations) {
          const otherTab = activeTab === "lisboa" ? "margem" : "lisboa";
          localStorage.setItem(`pref_${otherTab}_org`, fertagusDest);
          localStorage.setItem(`pref_${otherTab}_dest`, fertagusOrigin);
        }
      };

      window.populateSettingsUI = function () {
        const optsLisboa = FERTAGUS_STATIONS.map(
          (s) => `<option value="${s.key}">${s.name}</option>`,
        ).join("");

        // Populate Regular Stations Selects (Injected in Menu)
        const ids = [
          "set-lisboa-org",
          "set-lisboa-dest",
          "set-margem-org",
          "set-margem-dest",
        ];
        ids.forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = optsLisboa;
        });

        const setVal = (id, key, def) => {
          const el = document.getElementById(id);
          if (el) el.value = localStorage.getItem(key) || def;
        };

        setVal("set-lisboa-org", "pref_lisboa_org", "setubal");
        setVal("set-lisboa-dest", "pref_lisboa_dest", "roma_areeiro");
        setVal("set-margem-org", "pref_margem_org", "roma_areeiro");
        setVal("set-margem-dest", "pref_margem_dest", "setubal");

        setVal("smart-morning", "pref_morning", "lisboa");
        setVal("smart-afternoon", "pref_afternoon", "margem");

        updateSyncUI();
      };

      window.toggleRegularStations = function () {
        enableRegularStations = !enableRegularStations;
        localStorage.setItem("enable_regular", enableRegularStations);
        updateSettingsToggles();
      };

      window.toggleSmartSchedule = function () {
        enableSmartSchedule = !enableSmartSchedule;
        localStorage.setItem("enable_smart", enableSmartSchedule);
        updateSettingsToggles();
      };

      window.toggleSyncStations = function () {
        syncStations = !syncStations;
        localStorage.setItem("pref_sync_stations", syncStations);
        updateSyncUI();
      };

      window.updateSettingsToggles = function () {
        updateToggleVisual(
          "toggle-regular",
          "regular-stations-content",
          enableRegularStations,
        );
        updateToggleVisual(
          "toggle-smart",
          "smart-schedule-content",
          enableSmartSchedule,
        );
      };

      function updateToggleVisual(btnId, contentId, isEnabled) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const dot = btn.querySelector(".toggle-dot");
        const content = document.getElementById(contentId);

        if (isEnabled) {
          btn.classList.remove("bg-zinc-600");
          btn.classList.add("bg-blue-600");
          dot.classList.remove("translate-x-0");
          dot.classList.add(
            btnId === "btn-sync-stations" ? "translate-x-3" : "translate-x-5",
          );
          content.classList.remove("opacity-50", "pointer-events-none");
        } else {
          btn.classList.add("bg-zinc-600");
          btn.classList.remove("bg-blue-600");
          dot.classList.add("translate-x-0");
          dot.classList.remove(
            btnId === "btn-sync-stations" ? "translate-x-3" : "translate-x-5",
          );
          content.classList.add("opacity-50", "pointer-events-none");
        }
      }

      window.updateSyncUI = function () {
        const btn = document.getElementById("btn-sync-stations");
        if (!btn) return;
        const dot = btn.querySelector("div");
        const margemGroup = document.getElementById("settings-margem-group");

        if (syncStations) {
          btn.classList.add("bg-blue-600");
          btn.classList.remove("bg-zinc-600");
          dot.classList.add("translate-x-3");
          dot.classList.remove("translate-x-0");
          margemGroup.classList.add("hidden");
        } else {
          btn.classList.add("bg-zinc-600");
          btn.classList.remove("bg-blue-600");
          dot.classList.add("translate-x-0");
          dot.classList.remove("translate-x-3");
          margemGroup.classList.remove("hidden");
        }
      };

      window.saveRegularStations = function () {
        const lOrg = document.getElementById("set-lisboa-org").value;
        const lDest = document.getElementById("set-lisboa-dest").value;
        const mOrg = document.getElementById("set-margem-org").value;
        const mDest = document.getElementById("set-margem-dest").value;

        localStorage.setItem("pref_lisboa_org", lOrg);
        localStorage.setItem("pref_lisboa_dest", lDest);

        if (syncStations) {
          localStorage.setItem("pref_margem_org", lDest);
          localStorage.setItem("pref_margem_dest", lOrg);
        } else {
          localStorage.setItem("pref_margem_org", mOrg);
          localStorage.setItem("pref_margem_dest", mDest);
        }
      };

      window.saveSmartSchedule = function () {
        const morn = document.getElementById("smart-morning").value;
        const aft = document.getElementById("smart-afternoon").value;
        localStorage.setItem("pref_morning", morn);
        localStorage.setItem("pref_afternoon", aft);
      };

      window.setupPWA = function () {
        const iconUrl = new URL("./imagens/icon.svg", window.location.href)
          .href;
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = URL.createObjectURL(
          new Blob(
            [
              JSON.stringify({
                name: "LiveTagus",
                short_name: "LiveTagus",
                display: "standalone",
                background_color: "#09090b",
                theme_color: "#09090b",
                orientation: "portrait",
                icons: [
                  { src: iconUrl, sizes: "512x512", type: "image/svg+xml" },
                ],
              }),
            ],
            { type: "application/json" },
          ),
        );
        document.head.appendChild(link);

        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          updateAlertsSystem(currentTrainList).then(() => {
            renderList(currentTrainList);
          });
        });
      };

      window.installPWA = async function () {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          deferredPrompt = null;
          AlertsManager.dismiss(null, "pwa-install");
        }
      };

      window.populateOriginSelect = function () {
        const orgSel = document.getElementById("sel-origin");
        const dstSel = document.getElementById("sel-dest");

        if (!orgSel || !dstSel) return;

        // Populate options
        let options = [];
        if (activeTab === "lisboa") {
          options = FERTAGUS_STATIONS.slice(0, FERTAGUS_STATIONS.length);
        } else {
          options = FERTAGUS_STATIONS.slice().reverse();
        }

        const createOpts = (list) =>
          list
            .map((s) => `<option value="${s.key}">${s.name}</option>`)
            .join("");

        orgSel.innerHTML = createOpts(options);

        if (options.find((o) => o.key === fertagusOrigin)) {
          orgSel.value = fertagusOrigin;
        } else {
          orgSel.value = activeTab === "lisboa" ? "setubal" : "roma_areeiro";
          fertagusOrigin = orgSel.value;
        }

        // After setting origin, update dest
        updateDestinationOptions();
      };

      window.updateDestinationOptions = function () {
        const destSel = document.getElementById("sel-dest");
        if (!destSel) return;

        const orgIdx = FERTAGUS_STATIONS.findIndex(
          (s) => s.key === fertagusOrigin,
        );

        let validDestinations = [];
        if (activeTab === "lisboa") {
          validDestinations = FERTAGUS_STATIONS.slice(orgIdx + 1);
        } else {
          validDestinations = FERTAGUS_STATIONS.slice(0, orgIdx).reverse();
        }

        destSel.innerHTML = validDestinations
          .map((s) => `<option value="${s.key}">${s.name}</option>`)
          .join("");

        if (validDestinations.find((o) => o.key === fertagusDest)) {
          destSel.value = fertagusDest;
        } else {
          if (validDestinations.length > 0) {
            destSel.value = validDestinations[0].key;
            fertagusDest = destSel.value;
          }
        }
      };

      window.parseTimeStr = function (str) {
        if (!str) return null;
        const [h, m] = str.split(":").map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        if (d < new Date(Date.now() - 4 * 3600000)) d.setDate(d.getDate() + 1);
        return d;
      };

      window.addMinutes = function (str, min) {
        const d = parseTimeStr(str);
        if (!d) return "--:--";
        d.setMinutes(d.getMinutes() + min);
        return d.toLocaleTimeString("pt-PT", {
          hour: "2-digit",
          minute: "2-digit",
        });
      };

      window.updateNextCountdown = function () {
        if (!nextTrainDate) {
          document
            .getElementById("next-train-header")
            .classList.add("opacity-0", "hidden");
          return;
        }
        const now = new Date();
        let diff = Math.floor((nextTrainDate - now) / 1000);
        if (diff < 0) diff = 0;
        const min = Math.floor(diff / 60);
        const sec = Math.floor((diff % 60) / 10) * 10;
        document.getElementById("countdown-display").innerText =
          `${min} min ${sec.toString().padStart(2, "0")} s`;
        const header = document.getElementById("next-train-header");
        header.classList.remove("hidden");
        requestAnimationFrame(() => header.classList.remove("opacity-0"));
      };

      function getOperationalDate() {
        // Adjust for Portugal time (approximated by system time as per instructions to use "dia que é")
        // But respecting the 05:00 AM rule: 00:00 to 05:00 belongs to previous day.
        const d = new Date();
        if (d.getHours() < 3) {
          d.setDate(d.getDate() - 1);
        }
        return d;
      }

      function isWeekendOrHoliday(date) {
        const day = date.getDay(); // 0 = Sunday, 6 = Saturday
        const isWeekend = day === 0 || day === 6;
        if (isWeekend) return true;

        if (FERIADOS_DB) {
          // Format YYYY-MM-DD
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, "0");
          const d = String(date.getDate()).padStart(2, "0");
          const key = `${y}-${m}-${d}`;
          if (FERIADOS_DB[key]) return true;
        }
        return false;
      }

      function checkDayType() {
        const date = getOperationalDate();
        if (isWeekendOrHoliday(date)) return 2; // Weekend/Holiday
        return 0; // Business Day
      }

      const CLIENT_API_KEY =
        "KoKi30rVWuwkF9lqKL6j4mb0VMg3dIXWs6QDHZ3de0G8lC5qvu";

      async function fetchFertagusNewAPI() {
        const currentDB = activeTab === "lisboa" ? DB_LISBOA : DB_MARGEM;
        if (!currentDB) return [];
        try {
          const res = await fetch(API_FERTAGUS_NEW, {
            method: "GET",
            headers: {
              "x-api-key": CLIENT_API_KEY,
              Accept: "application/json",
            },
          });
          if (!res.ok) throw new Error("API Middleware Error");
          const data = await res.json();
          const currentDayType = checkDayType();
          const futureTrains = data.futureTrains || {};
          const apiTrains = Object.values(data).filter(
            (v) => v && v["id-comboio"],
          );
          const orgInfo = FERTAGUS_STATIONS.find(
            (s) => s.key === fertagusOrigin,
          );
          const dstInfo = FERTAGUS_STATIONS.find((s) => s.key === fertagusDest);
          const now = new Date();
          const allDbTrips = currentDB.trips.filter((trip) => {
            if (!trip[fertagusOrigin] || !trip[fertagusDest]) return false;
            if (trip.horario === 0 && currentDayType !== 0) return false;
            if (trip.horario === 2 && currentDayType !== 2) return false;
            return (
              parseTimeStr(trip[fertagusOrigin]) <
              parseTimeStr(trip[fertagusDest])
            );
          });

          const processed = allDbTrips
            .map((dbTrain) => {
              const scheduledTimeStr = dbTrain[fertagusOrigin];
              const scheduledDate = parseTimeStr(scheduledTimeStr);
              const scheduledDestStr = dbTrain[fertagusDest];
              const apiTrain = apiTrains.find(
                (t) => t["id-comboio"] == dbTrain.id,
              );
              let originNode = null;
              let destNode = null;
              if (apiTrain) {
                originNode = apiTrain.NodesPassagemComboio.find(
                  (n) => n.EstacaoID == orgInfo.id,
                );
                destNode = apiTrain.NodesPassagemComboio.find(
                  (n) =>
                    n.NomeEstacao.toUpperCase() === dstInfo.name.toUpperCase(),
                );
              }
              let mainTime = scheduledTimeStr;
              let secondaryTime = null;
              let status = "Programado";
              let dotStatus = "gray";
              let pulse = false;
              let context = null;
              let isLive = false;
              let isSuppressed = false;
              let hasPassedOrigin = false;
              let originLabel = "FERTAGUS";
              if (dbTrain.setubal) originLabel = "SETÚBAL";
              else if (dbTrain.coina) originLabel = "COINA";
              let arrTime = scheduledDestStr;

              if (apiTrain && originNode) {
                isLive = apiTrain.Live;
                isSuppressed = apiTrain.SituacaoComboio === "SUPRIMIDO";
                hasPassedOrigin = originNode.ComboioPassou;
                if (destNode && destNode.HoraPrevista) {
                  arrTime = destNode.HoraPrevista.substring(0, 5);
                }
                if (isSuppressed) {
                  status = "SUPRIMIDO";
                  dotStatus = "red";
                  pulse = true;
                } else if (apiTrain) {
                  const progStr = originNode.HoraProgramada;
                  const prevStr = originNode.HoraPrevista;
                  const obsStr = originNode.Observacoes;
                  let diffMin = 0;
                  let explicitDelayFound = false;
                  if (
                    apiTrain.SituacaoComboio &&
                    /atraso/i.test(apiTrain.SituacaoComboio)
                  ) {
                    const match = apiTrain.SituacaoComboio.match(/(\d+)/);
                    if (match) {
                      diffMin = parseInt(match[1]);
                      explicitDelayFound = true;
                    }
                  }
                  const obsMatch = obsStr
                    ? obsStr.match(/Hora Prevista:(\d{2}:\d{2})/)
                    : null;
                  if (obsMatch) {
                    mainTime = obsMatch[1];
                    if (!explicitDelayFound) {
                      const dProg = parseTimeStr(progStr);
                      const dObs = parseTimeStr(mainTime);
                      diffMin = Math.round((dObs - dProg) / 60000);
                    }
                  } else if (explicitDelayFound) {
                    mainTime = addMinutes(progStr, diffMin);
                  } else if (prevStr && prevStr !== progStr) {
                    mainTime = prevStr.substring(0, 5);
                    const dProg = parseTimeStr(progStr);
                    const dPrev = parseTimeStr(mainTime);
                    diffMin = Math.round((dPrev - dProg) / 60000);
                  } else {
                    mainTime = progStr.substring(0, 5);
                  }
                  if (diffMin > 0) {
                    status = `Atraso ${diffMin} min`;
                    dotStatus = "yellow";
                    pulse = true;
                    secondaryTime = progStr.substring(0, 5);
                    isLive = true;
                  } else {
                    if (isLive || explicitDelayFound || obsMatch) {
                      status = "A Horas";
                      dotStatus = "green";
                      pulse = true;
                      isLive = true;
                    } else {
                      status = "Programado";
                      dotStatus = "green";
                      pulse = true;
                    }
                  }
                  const currentIdx = apiTrain.NodesPassagemComboio.findIndex(
                    (n) => !n.ComboioPassou,
                  );
                  if (currentIdx >= 0) {
                    const currNode = apiTrain.NodesPassagemComboio[currentIdx];
                    const currName = currNode.NomeEstacao;
                    if (hasPassedOrigin && !isSuppressed)
                      status = `Em ${currName}`;
                    const prevNode =
                      currentIdx > 0
                        ? apiTrain.NodesPassagemComboio[currentIdx - 1]
                        : null;
                    const nextNode = apiTrain.NodesPassagemComboio[
                      currentIdx + 1
                    ]
                      ? apiTrain.NodesPassagemComboio[currentIdx + 1]
                      : null;
                    context = {
                      prev: prevNode
                        ? {
                            name: prevNode.NomeEstacao,
                            time: prevNode.HoraReal
                              ? prevNode.HoraReal.substring(0, 5)
                              : "--:--",
                          }
                        : null,
                      curr: {
                        name: currName,
                        time: currNode.HoraPrevista
                          ? currNode.HoraPrevista.substring(0, 5)
                          : currNode.HoraProgramada.substring(0, 5),
                      },
                      next: nextNode
                        ? {
                            name: nextNode.NomeEstacao,
                            time: nextNode.HoraPrevista
                              ? nextNode.HoraPrevista.substring(0, 5)
                              : nextNode.HoraProgramada.substring(0, 5),
                          }
                        : null,
                    };
                  }
                }
              } else {
                const fStatus = futureTrains[dbTrain.id];
                if (fStatus) {
                  if (fStatus.toUpperCase().includes("SUPRIMIDO")) {
                    status = "SUPRIMIDO";
                    dotStatus = "red";
                    pulse = true;
                    isSuppressed = true;
                  } else if (/atraso/i.test(fStatus)) {
                    const match = fStatus.match(/(\d+)/);
                    if (match) {
                      const delay = parseInt(match[1]);
                      status = `Atraso ${delay} min`;
                      dotStatus = "yellow";
                      pulse = true;
                      mainTime = addMinutes(scheduledTimeStr, delay);
                      secondaryTime = scheduledTimeStr;
                      isLive = true;
                    }
                  } else if (
                    /programado/i.test(fStatus) ||
                    /hora/i.test(fStatus)
                  ) {
                    status = "Programado";
                    dotStatus = "green";
                    pulse = true;
                  }
                }
              }
              if (isSuppressed && scheduledDate < now) return null;
              if (isLive) {
                if (destNode && destNode.ComboioPassou) return null;
              } else {
                if (scheduledDate < now) return null;
              }
              const effectiveDate = parseTimeStr(mainTime);
              return {
                id: dbTrain.id,
                num: dbTrain.id,
                op: originLabel,
                time: mainTime,
                secTime: secondaryTime,
                dest: dstInfo.name,
                status: status,
                arr: arrTime,
                dotStatus: dotStatus,
                pulse: pulse,
                isLive: isLive,
                isSuppressed: isSuppressed,
                carriages: dbTrain.carruagens,
                occupancy: dbTrain.ocupacao,
                context: context,
                isPassed: hasPassedOrigin,
                isEffectiveFuture: !hasPassedOrigin && !isSuppressed,
                rawTime: scheduledDate,
                effectiveDate: effectiveDate,
                fullSchedule: apiTrain ? apiTrain.NodesPassagemComboio : null,
              };
            })
            .filter((t) => t !== null)
            .sort((a, b) => a.effectiveDate - b.effectiveDate);
          return processed;
        } catch (e) {
          console.error("Erro Fertagus API:", e);
          return [];
        }
      }

      async function getTrains() {
        const apiData = await fetchFertagusNewAPI();
        return apiData;
      }

      function openDetails(trainId) {
        const t = currentTrainList.find((train) => train.id == trainId);
        if (!t) return;
        let occColorClass = "text-emerald-500",
          barColorClass = "bg-emerald-500";
        if (t.occupancy > 85) {
          occColorClass = "text-red-500";
          barColorClass = "bg-red-500";
        } else if (t.occupancy > 50) {
          occColorClass = "text-yellow-500";
          barColorClass = "bg-yellow-500";
        }

        let carsHtml = "";
        const count = t.carriages || 4;
        const filledCount = t.occupancy
          ? Math.round((t.occupancy / 100) * count)
          : count;
        if (t.occupancy !== null && t.occupancy !== undefined) {
          for (let c = 0; c < count; c++) {
            const isFilled = c < filledCount;
            const color = isFilled ? barColorClass : "bg-zinc-700/50";
            carsHtml += `<div class="h-2 flex-1 rounded-sm ${color} transition-all"></div>`;
          }
        } else {
          for (let c = 0; c < count; c++) {
            carsHtml += `<div class="h-2 flex-1 rounded-sm bg-zinc-700/50 border border-zinc-600/30"></div>`;
          }
        }
        let timelineHtml = "";
        if (t.fullSchedule) {
          t.fullSchedule.forEach((node, i) => {
            const isPassed = node.ComboioPassou;
            const isNext =
              !isPassed && (i === 0 || t.fullSchedule[i - 1].ComboioPassou);
            const dotColor = isPassed
              ? "bg-zinc-700 border-zinc-700"
              : isNext
                ? "bg-blue-500 border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.4)]"
                : "bg-zinc-800 border-zinc-600";
            const textColor = isPassed
              ? "text-zinc-600"
              : isNext
                ? "text-zinc-100 font-bold"
                : "text-zinc-500";
            const timeColor = isPassed
              ? "text-zinc-700"
              : isNext
                ? "text-blue-400 font-bold"
                : "text-zinc-500";
            const scheduledTime = node.HoraProgramada.substring(0, 5);
            const predictedTime = node.HoraPrevista
              ? node.HoraPrevista.substring(0, 5)
              : scheduledTime;
            let timeDisplay = scheduledTime;
            let subTime = "";
            if (predictedTime !== scheduledTime && !t.isSuppressed) {
              timeDisplay = predictedTime;
              subTime = scheduledTime;
            }
            timelineHtml += `
                    <div class="relative z-10 flex items-center mb-8 last:mb-0 group">
                        <div class="w-14 text-right mr-6 flex-shrink-0 flex flex-col items-end">
                            <span class="font-mono text-sm ${timeColor} leading-none">${timeDisplay}</span>
                            ${subTime ? `<span class="text-[9px] text-zinc-700 line-through decoration-zinc-700/50 mt-0.5">${subTime}</span>` : ""}
                        </div>
                        <div class="w-3 h-3 rounded-full border-2 ${dotColor} flex-shrink-0 transition-all group-hover:scale-110 z-20 relative"></div>
                        <div class="ml-6 flex-1">
                            <h4 class="text-sm ${textColor}">${node.NomeEstacao}</h4>
                            ${isPassed ? "" : isNext ? '<span class="text-[9px] text-blue-500 uppercase tracking-wider font-bold animate-pulse block mt-0.5">Próxima</span>' : ""}
                        </div>
                    </div>`;
          });
        } else {
          const currentDB = activeTab === "lisboa" ? DB_LISBOA : DB_MARGEM;
          const dbTrain = currentDB.trips.find((trip) => trip.id == t.id);
          if (dbTrain) {
            const stations = FERTAGUS_STATIONS.filter((st) => dbTrain[st.key]);
            let stationsToRender =
              activeTab === "margem" ? [...stations].reverse() : stations;
            stationsToRender.forEach((st) => {
              const time = dbTrain[st.key];
              if (time) {
                timelineHtml += `
                            <div class="relative z-10 flex items-center mb-8 last:mb-0">
                                <div class="w-14 text-right mr-6 flex-shrink-0">
                                    <span class="font-mono text-sm text-zinc-500 leading-none">${time}</span>
                                </div>
                                <div class="w-3 h-3 rounded-full border-2 bg-zinc-800 border-zinc-600 flex-shrink-0 z-20 relative"></div>
                                <div class="ml-6 flex-1">
                                    <h4 class="text-sm text-zinc-400">${st.name}</h4>
                                </div>
                            </div>`;
              }
            });
          }
        }
        const fullContent = `
                <div class="flex flex-col h-full bg-[#09090b]">
                    <!-- Header Sticky -->
                    <div class="relative z-20 backdrop-blur-md border-b border-white/5 pt-6 pb-6 px-6 shadow-xl bg-zinc-50 dark:bg-zinc-900/65">
                        <button onclick="closeDetails()" class="absolute top-5 right-5 p-2 bg-white/5 hover:bg-white/10 rounded-full text-zinc-400 hover:text-white transition-all">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                        <div class="flex flex-col gap-6">
                            <!-- Title Section -->
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">Fertagus</span>
                                    <span class="font-mono text-xs text-zinc-600 dark:text-zinc-400">#${t.num}</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <h2 class="text-2xl font-bold tracking-tight leading-none text-zinc-900 dark:text-zinc-100">${t.dest}</h2>
                                    <div class="text-right">
                                        <span class="text-3xl font-mono font-bold tracking-tighter leading-none text-zinc-900 dark:text-zinc-100">${t.time}</span>
                                        ${t.secTime ? `<span class="block text-xs text-zinc-600 dark:text-zinc-400 line-through text-right mt-0.5 font-mono">${t.secTime}</span>` : ""}
                                    </div>
                                </div>
                                <div class="flex items-center justify-between mt-3">
                                    <span class="text-xs text-zinc-500 dark:text-zinc-400">De <span class="font-medium text-zinc-400 dark:text-zinc-300">${t.op === "FERTAGUS" ? (activeTab === "lisboa" ? "Setúbal/Coina" : "Roma-Areeiro") : t.op}</span></span>
                                    <div class="flex items-center gap-2 px-2 py-1 rounded-full bg-black/5 dark:bg-white/5 border border-black/5 dark:border-white/5">
                                        <div class="w-1.5 h-1.5 rounded-full ${t.dotStatus === "green" ? "bg-emerald-500" : t.dotStatus === "yellow" ? "bg-yellow-500" : "bg-red-500"} animate-pulse"></div>
                                        <span class="text-[10px] font-bold uppercase text-zinc-500 dark:text-zinc-300 leading-none">${t.status}</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="rounded-xl p-3 border border-black/5 dark:border-white/5 flex flex-col justify-between min-h-[70px] bg-white/50 dark:bg-zinc-800/40">
                                    <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Carruagens</span>
                                    <div class="flex items-end gap-1 mt-1">
                                        <span class="text-2xl font-mono font-bold leading-none text-zinc-900 dark:text-zinc-100">${t.carriages}</span>
                                        <span class="text-[10px] text-zinc-500 mb-0.5">unid.</span>
                                    </div>
                                </div>
                                <div class="rounded-xl p-3 border border-black/5 dark:border-white/5 flex flex-col justify-between min-h-[70px] bg-white/50 dark:bg-zinc-800/40">
                                    <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Ocupação</span>
                                    <div class="flex items-end gap-1 mt-1">
                                        ${t.occupancy !== null ? `<span class="text-2xl font-mono font-bold ${occColorClass} leading-none">${t.occupancy}%</span>` : `<span class="text-sm text-zinc-600 italic">--</span>`}
                                    </div>
                                </div>
                            </div>
                            ${t.occupancy !== null ? `<div class="flex gap-1.5 w-full mt-1">${carsHtml}</div>` : ""}
                        </div>
                    </div>
                    <!-- Scrollable Timeline -->
                    <div class="flex-grow overflow-y-auto px-6 py-8 relative bg-zinc-50 dark:bg-[#09090b]">
                        <div class="absolute left-[85px] top-0 bottom-0 w-[1px] bg-zinc-300 dark:bg-zinc-800"></div>
                        ${timelineHtml}
                        <div class="h-12"></div>
                    </div>
                </div>
            `;
        const modal = document.getElementById("train-details-modal");
        modal.innerHTML = fullContent;
        const backdrop = document.getElementById("modal-backdrop");
        modal.classList.remove("translate-y-full");
        backdrop.classList.remove("hidden");
        setTimeout(() => backdrop.classList.remove("opacity-0"), 10);
        if (window.lucide) lucide.createIcons();
      }

      function closeDetails() {
        const modal = document.getElementById("train-details-modal");
        const backdrop = document.getElementById("modal-backdrop");
        modal.classList.add("translate-y-full");
        backdrop.classList.add("opacity-0");
        setTimeout(() => backdrop.classList.add("hidden"), 300);
      }

      window.renderList = function (list) {
        const container = document.getElementById("train-list");
        const loadMoreBtn = document.getElementById("load-more-btn");
        currentTrainList = list;
        container.innerHTML = "";

        if (!list || !list.length) {
          container.innerHTML = `<div class="h-60 flex flex-col items-center justify-center text-zinc-500 gap-3"><i data-lucide="train-track" class="w-10 h-10 opacity-20"></i><p class="text-xs tracking-wider uppercase font-medium">Sem comboios próximos<br><a class="text-center underline underline-offset-2" href="./horarios">Vê Horários Offline</a></p></div>`;
          if (window.lucide) lucide.createIcons();
          loadMoreBtn.classList.add("hidden");
          nextTrainDate = null;
          updateNextCountdown();
          return;
        }

        const visibleList = list.slice(0, displayLimit);
        if (list.length > displayLimit) loadMoreBtn.classList.remove("hidden");
        else loadMoreBtn.classList.add("hidden");

        const colorText = "text-blue-500 dark:text-blue-400";
        let nextTrainIndex = list.findIndex(
          (t) => t.isEffectiveFuture && !t.isSuppressed,
        );
        if (nextTrainIndex === -1 && list.some((t) => !t.isSuppressed))
          nextTrainIndex = list.length - 1;
        if (nextTrainIndex === -1) nextTrainIndex = 0;

        nextTrainDate = list[nextTrainIndex]?.effectiveDate;
        updateNextCountdown();

        const dividerHTML = `
                <div class="flex items-center gap-4 py-4 opacity-80 scroll-mt-[180px]" id="next-divider">
                    <div class="flex-1 h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
                    <span class="text-[0.65rem] font-extrabold uppercase tracking-[0.2em] text-blue-500 whitespace-nowrap">Próximo Comboio</span>
                    <div class="flex-1 h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
                </div>
            `;

        visibleList.forEach((t, i) => {
          const cardId = `train-${t.id}`;
          const isNext = i === nextTrainIndex;
          const isPassed = i < nextTrainIndex;

          if (isNext) {
            container.insertAdjacentHTML("beforeend", dividerHTML);
            const alertsHTML = AlertsManager.generateHTML(activeAlerts);
            if (alertsHTML)
              container.insertAdjacentHTML("beforeend", alertsHTML);
          }

          let dotClass = "bg-zinc-400 dark:bg-zinc-600",
            glowColor = "rgba(59, 130, 246, 0.5)";
          if (t.dotStatus === "green") {
            dotClass = "bg-emerald-500";
            glowColor = "rgba(16, 185, 129, 0.5)";
          } else if (t.dotStatus === "yellow") {
            dotClass = "bg-amber-500";
            glowColor = "rgba(245, 158, 11, 0.5)";
          } else if (t.dotStatus === "red") {
            dotClass = "bg-red-500";
            glowColor = "rgba(239, 68, 68, 0.5)";
          }

          dotClass += ` shadow-[0_0_8px_${glowColor}]`;
          let pulseStyle =
            t.dotStatus !== "gray"
              ? `style="--dot-color-glow: ${glowColor}"`
              : "";
          if (t.dotStatus !== "gray") dotClass += " dot-ping";

          const opacityClass = isPassed
            ? "opacity-60 grayscale-[0.5]"
            : "opacity-100";
          const timeClass = t.isSuppressed
            ? "line-through text-zinc-500 opacity-70"
            : "";
          const arrClass = t.isSuppressed ? "opacity-0" : "";
          const statusTextClass = t.isSuppressed
            ? "text-red-500 font-bold"
            : t.status.includes("Atraso")
              ? "text-yellow-600 dark:text-yellow-400"
              : "text-zinc-500 dark:text-zinc-400";

          let carsHtml = "";
          if (t.carriages) {
            const occ = t.occupancy !== null ? t.occupancy : 0;
            let fillColor =
              occ === 0
                ? "bg-blue-500"
                : occ > 85
                  ? "bg-red-500"
                  : occ > 50
                    ? "bg-yellow-500"
                    : "bg-emerald-500";
            const wrapperWidth = t.carriages === 8 ? "w-full" : "w-1/2";
            const filledCount = t.occupancy
              ? Math.round((t.occupancy / 100) * t.carriages)
              : t.carriages;
            let blocks = "";
            for (let c = 0; c < t.carriages; c++) {
              const colorClass =
                c < filledCount ? fillColor : "bg-zinc-300 dark:bg-zinc-700";
              blocks += `<div class="h-[6px] rounded-[2px] transition-all duration-300 ease-out flex-1 ${colorClass} opacity-90"></div>`;
            }
            carsHtml = `<div class="flex justify-center w-full mt-3"><div class="flex gap-1 h-1.5 ${wrapperWidth}">${blocks}</div></div>`;
          }

          let contextHtml = "";
          if (t.context) {
            contextHtml = `
                    <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center gap-2 w-full text-[9px] text-zinc-500">
                        <div class="flex items-center justify-end gap-1 opacity-60">
                            ${t.context.prev ? `<span class="truncate max-w-[70px]">${t.context.prev.name}</span><span>-</span>` : ""}
                        </div>
                        <div class="flex flex-col items-center text-zinc-700 dark:text-zinc-300 font-bold scale-110 justify-self-center min-w-[80px]">
                            <span>${t.context.curr.name}</span>
                        </div>
                        <div class="flex items-center justify-start gap-1 opacity-60">
                            ${t.context.next ? `<span>-</span><span class="truncate max-w-[70px]">${t.context.next.name}</span>` : ""}
                        </div>
                    </div>`;
          }

          const innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full border border-black/5 dark:border-white/5 bg-black/5 dark:bg-white/5 text-zinc-500 dark:text-zinc-400 tracking-wider uppercase">${t.op}</span>
                                <span class="text-[9px] font-mono text-zinc-400 dark:text-zinc-500">#${t.num}</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="font-mono text-4xl font-medium tracking-tighter leading-none ${timeClass} text-zinc-900 dark:text-zinc-100">${t.time}</span>
                                ${t.secTime ? `<span class="text-[0.55em] line-through opacity-60 font-medium ml-2 text-zinc-500 align-baseline font-mono text-sm">${t.secTime}</span>` : ""}
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-end">
                            <h3 class="text-xs font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wide text-right truncate max-w-[100px]">${t.dest}</h3>
                            <div class="flex items-baseline mt-1 ${arrClass}">
                                <span class="text-[10px] text-zinc-600 dark:text-zinc-500 mr-1">Chegada</span>
                                <span style="font-size:1.125rem;line-height:1.75rem" class="font-mono text-lg font-medium ${colorText}">${t.arr}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between gap-2 mb-1">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full ${dotClass}" ${pulseStyle}></div>
                            <span class="text-[10px] uppercase tracking-wide font-medium ${statusTextClass}">${t.status}</span>
                        </div>
                        <button onclick="openDetails('${t.id}')" class="text-[10px] font-medium text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-300 underline decoration-zinc-300 dark:decoration-zinc-700 underline-offset-2 transition-colors">Ver Detalhes</button>
                    </div>
                    ${carsHtml}
                    ${contextHtml}
                `;

          const card = document.createElement("div");
          card.id = cardId;
          card.setAttribute("data-id", cardId);
          card.className = `bg-white/90 dark:bg-zinc-800/40 backdrop-blur-sm border border-black/5 dark:border-white/5 shadow-sm rounded-2xl p-5 relative overflow-hidden group ${opacityClass}`;
          card.innerHTML = innerHTML;
          container.appendChild(card);
        });

        if (!window.hasScrolledNext && nextTrainIndex !== -1) {
          setTimeout(() => {
            const el = document.getElementById("alerts-dynamic-container");
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
            window.hasScrolledNext = true;
          }, 800);
        }

        if (activeAlerts.length > 1) {
          const dots = document.querySelectorAll("#alerts-pagination div");
          const slider = document.getElementById("alerts-slider");
          if (slider && dots) {
            slider.onscroll = () => {
              const scrollLeft = slider.scrollLeft;
              const width = slider.offsetWidth;
              const index = Math.round(scrollLeft / width);
              dots.forEach((d, i) => {
                d.className =
                  i === index
                    ? "bg-blue-500 w-3 h-1.5 rounded-full transition-all duration-300"
                    : "bg-zinc-300 dark:bg-zinc-700 w-1.5 h-1.5 rounded-full transition-all duration-300";
              });
            };
          }
        }
      };

      window.loadMore = function () {
        displayLimit += 10;
        renderList(currentTrainList);
      };

      window.setStatus = function (s, msg) {
        const ping = document.getElementById("status-ping"),
          icon = document.getElementById("refresh-icon-menu");
        const lastUpd = document.getElementById("last-updated");

        if (s === "loading") {
          if (icon) icon.classList.add("animate-spin");
        } else if (s === "error" || s === "offline") {
          if (ping)
            ping.className =
              "relative inline-flex h-1.5 w-1.5 rounded-full " +
              (s === "offline" ? "bg-zinc-500" : "bg-red-500");
          if (lastUpd) lastUpd.innerText = "Offline";
          if (icon) icon.classList.remove("animate-spin");
        } else {
          if (ping)
            ping.className =
              "relative inline-flex h-1.5 w-1.5 rounded-full bg-blue-500 dot-ping";
          if (lastUpd)
            lastUpd.innerText = new Date()
              .toLocaleTimeString("pt-PT")
              .substring(0, 5);
          if (icon) icon.classList.remove("animate-spin");
        }
      };

      window.loadData = async function (silent = false) {
        if (isLoading) return;
        isLoading = true;
        if (!silent) setStatus("loading", "A atualizar...");

        try {
          if (!silent) await new Promise((r) => setTimeout(r, 300));
          const data = await getTrains();
          await updateAlertsSystem(data);
          renderList(data);
          if (data.length > 0) setStatus("success");
          else if (activeTab === "lisboa") setStatus("offline", "Sem Dados");
          else setStatus("success", "Online");
        } catch (e) {
          console.error(e);
          setStatus("error");
        } finally {
          isLoading = false;
          if (window.lucide) lucide.createIcons();

          // focusOnContent();
        }
      };
      window.manualRefresh = function () {
        console.log("manual refresh");
        focusOnContent();
        loadData(false);
      };

      window.switchTab = function (t) {
        if (t !== activeTab) {
          const oldOrg = fertagusOrigin;
          fertagusOrigin = fertagusDest;
          fertagusDest = oldOrg;
        }

        activeTab = t;

        // Update ambient light color if needed, simplified to blue
        document.getElementById("ambient-light").className =
          `fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] rounded-full blur-[120px] pointer-events-none transition-colors duration-1000 bg-blue-500/10`;

        populateOriginSelect();
        populateDestSelect(fertagusOrigin); // Ensure destination is correctly populated for new origin context
        validateRoute();
        // updateStationLabels(); // Removed as per previous instructions to use Selects
        saveState();

        document.getElementById("train-list").innerHTML = "";
        window.hasScrolledNext = false;
        document.getElementById("next-train-header").classList.add("hidden");

        loadData(false);
      };

      window.saveState = function () {
        localStorage.setItem("ft_org", fertagusOrigin);
        localStorage.setItem("ft_dst", fertagusDest);
        localStorage.setItem("ft_tab", activeTab);
      };

      window.onload = function () {
        init();
      };

      async function init() {
        // Prevent browser scroll restoration on reload
        if ("scrollRestoration" in history) {
          history.scrollRestoration = "manual";
        }

        setupPWA();
        loadSettings();
        const savedOrg = localStorage.getItem("ft_org");
        const savedDest = localStorage.getItem("ft_dst");
        const savedTab = localStorage.getItem("ft_tab");

        if (savedOrg) fertagusOrigin = savedOrg;
        if (savedDest) fertagusDest = savedDest;
        if (savedTab) activeTab = savedTab;
        // Espera pelo menu.js carregar o DOM (pequeno timeout de segurança)
        setTimeout(injectCustomMenuElements, 100);

        try {
          const [resLisboa, resMargem, resFeriados] = await Promise.all([
            fetch("./json/fertagus_sentido_lisboa.json"),
            fetch("./json/fertagus_sentido_margem.json"),
            fetch("./json/feriados.json"),
          ]);

          if (resLisboa.ok) DB_LISBOA = await resLisboa.json();
          if (resMargem.ok) DB_MARGEM = await resMargem.json();
          if (resFeriados.ok) FERIADOS_DB = await resFeriados.json();
        } catch (e) {
          console.error("DB Load Error:", e);
          DB_LISBOA = { trips: [] };
          DB_MARGEM = { trips: [] };
          FERIADOS_DB = {};
        }

        const nowH = new Date().getHours();
        let targetTab = "lisboa";
        if (enableSmartSchedule) {
          const morningPref = localStorage.getItem("pref_morning") || "lisboa";
          const afternoonPref =
            localStorage.getItem("pref_afternoon") || "margem";
          if (nowH >= 5 && nowH < 13) targetTab = morningPref;
          else if (nowH >= 13 || nowH < 2) targetTab = afternoonPref;
        } else {
          const savedTab = localStorage.getItem("ft_tab");
          if (savedTab) targetTab = savedTab;
        }

        activeTab = targetTab;
        loadStationPrefs(activeTab);

        // Initial Population
        populateOriginSelect();
        populateDestSelect(fertagusOrigin);

        // Ensure values match state
        const orgSel = document.getElementById("sel-origin");
        const dstSel = document.getElementById("sel-dest");
        if (orgSel) orgSel.value = fertagusOrigin;
        if (dstSel) dstSel.value = fertagusDest;

        updateAppState(); // Replaces updateStations() for cleaner initial load

        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => {
          if (!isLoading) loadData(true);
        }, 30000);

        if (nextTrainInterval) clearInterval(nextTrainInterval);
        nextTrainInterval = setInterval(updateNextCountdown, 1000);

        if (window.lucide) lucide.createIcons();
      }
    </script>
  </body>
</html>
